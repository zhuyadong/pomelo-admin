"use strict";
/*!
 * Pomelo -- consoleModule runScript
 * Copyright(c) 2012 fantasyni <fantasyni@163.com>
 * MIT Licensed
 */
const monitor = require("pomelo-monitor");
const logger = require("pomelo-logger").getLogger("pomelo-admin", __filename);
const vm = require("vm");
const fs = require("fs");
const util = require("util");
const path = require("path");
module.exports.moduleId = "scripts";
class ScriptsModule {
    constructor(opts) {
        this.commands = {
            list: list,
            get: get,
            save: save,
            run: run
        };
        this.app = opts.app;
        this.root = opts.path;
    }
    monitorHandler(agent, msg, cb) {
        let context = {
            app: this.app,
            require: require,
            os: require("os"),
            fs: require("fs"),
            process: process,
            util: util
        };
        try {
            vm.runInNewContext(msg.script, context);
            let result = context.result;
            if (!result) {
                cb(null, "script result should be assigned to result value to script module context");
            }
            else {
                cb(null, result);
            }
        }
        catch (e) {
            cb(null, e.toString());
        }
        //cb(null, vm.runInContext(msg.script, context));
    }
    clientHandler(agent, msg, cb) {
        let fun = this.commands[msg.command];
        if (!fun || typeof fun !== "function") {
            cb("unknown command:" + msg.command);
            return;
        }
        fun(this, agent, msg, cb);
    }
}
/**
 * List server id and scripts file name
 */
function list(scriptModule, agent, msg, cb) {
    let servers = [];
    let scripts = [];
    let idMap = agent.idMap;
    for (let sid in idMap) {
        servers.push(sid);
    }
    fs.readdir(scriptModule.root, function (err, filenames) {
        if (err) {
            filenames = [];
        }
        for (let i = 0, l = filenames.length; i < l; i++) {
            scripts.push(filenames[i]);
        }
        cb(null, {
            servers: servers,
            scripts: scripts
        });
    });
}
/**
 * Get the content of the script file
 */
function get(scriptModule, agent, msg, cb) {
    let filename = msg.filename;
    if (!filename) {
        cb("empty filename");
        return;
    }
    fs.readFile(path.join(scriptModule.root, filename), "utf-8", function (err, data) {
        if (err) {
            logger.error("fail to read script file:" + filename + ", " + err.stack);
            cb("fail to read script with name:" + filename);
        }
        cb(null, data);
    });
}
/**
 * Save a script file that posted from admin console
 */
function save(scriptModule, agent, msg, cb) {
    let filepath = path.join(scriptModule.root, msg.filename);
    fs.writeFile(filepath, msg.body, function (err) {
        if (err) {
            logger.error("fail to write script file:" + msg.filename + ", " + err.stack);
            cb("fail to write script file:" + msg.filename);
            return;
        }
        cb();
    });
}
/**
 * Run the script on the specified server
 */
function run(scriptModule, agent, msg, cb) {
    agent.request(msg.serverId, module.exports.moduleId, msg, (err, res) => {
        if (err) {
            logger.error("fail to run script for " + err.stack);
            return;
        }
        cb(null, res);
    });
}
module.exports = (opts) => {
    return new ScriptsModule(opts);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjcmlwdHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUMxQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM5RSx5QkFBMEI7QUFDMUIseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5Qiw2QkFBOEI7QUFROUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDO0FBRXBDO0lBU0MsWUFBWSxJQUFTO1FBTlosYUFBUSxHQUFHO1lBQ25CLElBQUksRUFBRSxJQUFJO1lBQ1YsR0FBRyxFQUFFLEdBQUc7WUFDUixJQUFJLEVBQUUsSUFBSTtZQUNWLEdBQUcsRUFBRSxHQUFHO1NBQ1IsQ0FBQztRQUVELElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDdkIsQ0FBQztJQUVELGNBQWMsQ0FBQyxLQUFpQyxFQUFFLEdBQVEsRUFBRSxFQUFZO1FBQ3ZFLElBQUksT0FBTyxHQUFHO1lBQ2IsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO1lBQ2IsT0FBTyxFQUFFLE9BQU87WUFDaEIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDakIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDakIsT0FBTyxFQUFFLE9BQU87WUFDaEIsSUFBSSxFQUFFLElBQUk7U0FDVixDQUFDO1FBQ0YsSUFBSSxDQUFDO1lBQ0osRUFBRSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXhDLElBQUksTUFBTSxHQUFTLE9B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Q1IsQ0FBQztRQUNELEVBQUUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDZixDQUFDLENBQ0QsQ0FBQztBQUNILENBQUM7QUF0S0QsaUJBQVMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtJQUN0QixNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBQb21lbG8gLS0gY29uc29sZU1vZHVsZSBydW5TY3JpcHRcbiAqIENvcHlyaWdodChjKSAyMDEyIGZhbnRhc3luaSA8ZmFudGFzeW5pQDE2My5jb20+XG4gKiBNSVQgTGljZW5zZWRcbiAqL1xuY29uc3QgbW9uaXRvciA9IHJlcXVpcmUoXCJwb21lbG8tbW9uaXRvclwiKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsby1hZG1pblwiLCBfX2ZpbGVuYW1lKTtcbmltcG9ydCB2bSA9IHJlcXVpcmUoXCJ2bVwiKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcbmltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuaW1wb3J0IHsgTWFzdGVyQWdlbnQgfSBmcm9tIFwiLi4vbWFzdGVyL21hc3RlckFnZW50XCI7XG5pbXBvcnQgeyBNb25pdG9yQWdlbnQgfSBmcm9tIFwiLi4vbW9uaXRvci9tb25pdG9yQWdlbnRcIjtcblxuZXhwb3J0ID0gKG9wdHM6IGFueSkgPT4ge1xuXHRyZXR1cm4gbmV3IFNjcmlwdHNNb2R1bGUob3B0cyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5tb2R1bGVJZCA9IFwic2NyaXB0c1wiO1xuXG5jbGFzcyBTY3JpcHRzTW9kdWxlIHtcblx0cmVhZG9ubHkgYXBwOiBhbnk7XG5cdHJlYWRvbmx5IHJvb3Q6IHN0cmluZztcblx0cmVhZG9ubHkgY29tbWFuZHMgPSB7XG5cdFx0bGlzdDogbGlzdCxcblx0XHRnZXQ6IGdldCxcblx0XHRzYXZlOiBzYXZlLFxuXHRcdHJ1bjogcnVuXG5cdH07XG5cdGNvbnN0cnVjdG9yKG9wdHM6IGFueSkge1xuXHRcdHRoaXMuYXBwID0gb3B0cy5hcHA7XG5cdFx0dGhpcy5yb290ID0gb3B0cy5wYXRoO1xuXHR9XG5cblx0bW9uaXRvckhhbmRsZXIoYWdlbnQ6IE1hc3RlckFnZW50ICYgTW9uaXRvckFnZW50LCBtc2c6IGFueSwgY2I6IEZ1bmN0aW9uKSB7XG5cdFx0bGV0IGNvbnRleHQgPSB7XG5cdFx0XHRhcHA6IHRoaXMuYXBwLFxuXHRcdFx0cmVxdWlyZTogcmVxdWlyZSxcblx0XHRcdG9zOiByZXF1aXJlKFwib3NcIiksXG5cdFx0XHRmczogcmVxdWlyZShcImZzXCIpLFxuXHRcdFx0cHJvY2VzczogcHJvY2Vzcyxcblx0XHRcdHV0aWw6IHV0aWxcblx0XHR9O1xuXHRcdHRyeSB7XG5cdFx0XHR2bS5ydW5Jbk5ld0NvbnRleHQobXNnLnNjcmlwdCwgY29udGV4dCk7XG5cblx0XHRcdGxldCByZXN1bHQgPSAoPGFueT5jb250ZXh0KS5yZXN1bHQ7XG5cdFx0XHRpZiAoIXJlc3VsdCkge1xuXHRcdFx0XHRjYihcblx0XHRcdFx0XHRudWxsLFxuXHRcdFx0XHRcdFwic2NyaXB0IHJlc3VsdCBzaG91bGQgYmUgYXNzaWduZWQgdG8gcmVzdWx0IHZhbHVlIHRvIHNjcmlwdCBtb2R1bGUgY29udGV4dFwiXG5cdFx0XHRcdCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjYihudWxsLCByZXN1bHQpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdGNiKG51bGwsIGUudG9TdHJpbmcoKSk7XG5cdFx0fVxuXG5cdFx0Ly9jYihudWxsLCB2bS5ydW5JbkNvbnRleHQobXNnLnNjcmlwdCwgY29udGV4dCkpO1xuXHR9XG5cblx0Y2xpZW50SGFuZGxlcihhZ2VudDogTWFzdGVyQWdlbnQgJiBNb25pdG9yQWdlbnQsIG1zZzogYW55LCBjYjogRnVuY3Rpb24pIHtcblx0XHRsZXQgZnVuID0gKDxhbnk+dGhpcykuY29tbWFuZHNbbXNnLmNvbW1hbmRdO1xuXHRcdGlmICghZnVuIHx8IHR5cGVvZiBmdW4gIT09IFwiZnVuY3Rpb25cIikge1xuXHRcdFx0Y2IoXCJ1bmtub3duIGNvbW1hbmQ6XCIgKyBtc2cuY29tbWFuZCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0ZnVuKHRoaXMsIGFnZW50LCBtc2csIGNiKTtcblx0fVxufVxuXG4vKipcbiAqIExpc3Qgc2VydmVyIGlkIGFuZCBzY3JpcHRzIGZpbGUgbmFtZVxuICovXG5mdW5jdGlvbiBsaXN0KFxuXHRzY3JpcHRNb2R1bGU6IFNjcmlwdHNNb2R1bGUsXG5cdGFnZW50OiBNYXN0ZXJBZ2VudCAmIE1vbml0b3JBZ2VudCxcblx0bXNnOiBhbnksXG5cdGNiOiBGdW5jdGlvblxuKSB7XG5cdGxldCBzZXJ2ZXJzOiBhbnkgPSBbXTtcblx0bGV0IHNjcmlwdHM6IGFueSA9IFtdO1xuXHRsZXQgaWRNYXAgPSBhZ2VudC5pZE1hcDtcblxuXHRmb3IgKGxldCBzaWQgaW4gaWRNYXApIHtcblx0XHRzZXJ2ZXJzLnB1c2goc2lkKTtcblx0fVxuXG5cdGZzLnJlYWRkaXIoc2NyaXB0TW9kdWxlLnJvb3QsIGZ1bmN0aW9uKGVyciwgZmlsZW5hbWVzKSB7XG5cdFx0aWYgKGVycikge1xuXHRcdFx0ZmlsZW5hbWVzID0gW107XG5cdFx0fVxuXHRcdGZvciAobGV0IGkgPSAwLCBsID0gZmlsZW5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuXHRcdFx0c2NyaXB0cy5wdXNoKGZpbGVuYW1lc1tpXSk7XG5cdFx0fVxuXG5cdFx0Y2IobnVsbCwge1xuXHRcdFx0c2VydmVyczogc2VydmVycyxcblx0XHRcdHNjcmlwdHM6IHNjcmlwdHNcblx0XHR9KTtcblx0fSk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBjb250ZW50IG9mIHRoZSBzY3JpcHQgZmlsZVxuICovXG5mdW5jdGlvbiBnZXQoXG5cdHNjcmlwdE1vZHVsZTogU2NyaXB0c01vZHVsZSxcblx0YWdlbnQ6IE1hc3RlckFnZW50ICYgTW9uaXRvckFnZW50LFxuXHRtc2c6IGFueSxcblx0Y2I6IEZ1bmN0aW9uXG4pIHtcblx0bGV0IGZpbGVuYW1lID0gbXNnLmZpbGVuYW1lO1xuXHRpZiAoIWZpbGVuYW1lKSB7XG5cdFx0Y2IoXCJlbXB0eSBmaWxlbmFtZVwiKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRmcy5yZWFkRmlsZShwYXRoLmpvaW4oc2NyaXB0TW9kdWxlLnJvb3QsIGZpbGVuYW1lKSwgXCJ1dGYtOFwiLCBmdW5jdGlvbihcblx0XHRlcnIsXG5cdFx0ZGF0YVxuXHQpIHtcblx0XHRpZiAoZXJyKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFwiZmFpbCB0byByZWFkIHNjcmlwdCBmaWxlOlwiICsgZmlsZW5hbWUgKyBcIiwgXCIgKyBlcnIuc3RhY2tcblx0XHRcdCk7XG5cdFx0XHRjYihcImZhaWwgdG8gcmVhZCBzY3JpcHQgd2l0aCBuYW1lOlwiICsgZmlsZW5hbWUpO1xuXHRcdH1cblxuXHRcdGNiKG51bGwsIGRhdGEpO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBTYXZlIGEgc2NyaXB0IGZpbGUgdGhhdCBwb3N0ZWQgZnJvbSBhZG1pbiBjb25zb2xlXG4gKi9cbmZ1bmN0aW9uIHNhdmUoXG5cdHNjcmlwdE1vZHVsZTogU2NyaXB0c01vZHVsZSxcblx0YWdlbnQ6IE1hc3RlckFnZW50ICYgTW9uaXRvckFnZW50LFxuXHRtc2c6IGFueSxcblx0Y2I6IEZ1bmN0aW9uXG4pIHtcblx0bGV0IGZpbGVwYXRoID0gcGF0aC5qb2luKHNjcmlwdE1vZHVsZS5yb290LCBtc2cuZmlsZW5hbWUpO1xuXG5cdGZzLndyaXRlRmlsZShmaWxlcGF0aCwgbXNnLmJvZHksIGZ1bmN0aW9uKGVycikge1xuXHRcdGlmIChlcnIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XCJmYWlsIHRvIHdyaXRlIHNjcmlwdCBmaWxlOlwiICsgbXNnLmZpbGVuYW1lICsgXCIsIFwiICsgZXJyLnN0YWNrXG5cdFx0XHQpO1xuXHRcdFx0Y2IoXCJmYWlsIHRvIHdyaXRlIHNjcmlwdCBmaWxlOlwiICsgbXNnLmZpbGVuYW1lKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjYigpO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBSdW4gdGhlIHNjcmlwdCBvbiB0aGUgc3BlY2lmaWVkIHNlcnZlclxuICovXG5mdW5jdGlvbiBydW4oXG5cdHNjcmlwdE1vZHVsZTogU2NyaXB0c01vZHVsZSxcblx0YWdlbnQ6IE1hc3RlckFnZW50ICYgTW9uaXRvckFnZW50LFxuXHRtc2c6IGFueSxcblx0Y2I6IEZ1bmN0aW9uXG4pIHtcblx0YWdlbnQucmVxdWVzdChcblx0XHRtc2cuc2VydmVySWQsXG5cdFx0bW9kdWxlLmV4cG9ydHMubW9kdWxlSWQsXG5cdFx0bXNnLFxuXHRcdChlcnI6IGFueSwgcmVzOiBhbnkpID0+IHtcblx0XHRcdGlmIChlcnIpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKFwiZmFpbCB0byBydW4gc2NyaXB0IGZvciBcIiArIGVyci5zdGFjayk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdGNiKG51bGwsIHJlcyk7XG5cdFx0fVxuXHQpO1xufVxuIl19