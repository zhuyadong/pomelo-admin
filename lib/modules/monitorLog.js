"use strict";
/*!
 * Pomelo -- consoleModule monitorLog
 * Copyright(c) 2012 fantasyni <fantasyni@163.com>
 * MIT Licensed
 */
const logger = require("pomelo-logger").getLogger("pomelo-admin", __filename);
const exec = require("child_process").exec;
const path = require("path");
const DEFAULT_INTERVAL = 5 * 60; // in second
module.exports.moduleId = "monitorLog";
class MonitorLogModule {
    /**
     * Initialize a new 'Module' with the given 'opts'
     *
     * @class Module
     * @constructor
     * @param {object} opts
     * @api public
     */
    constructor(opts) {
        opts = opts || {};
        this.root = opts.path;
        this.interval = opts.interval || DEFAULT_INTERVAL;
    }
    /**
     * collect monitor data from monitor
     *
     * @param {Object} agent monitorAgent object
     * @param {Object} msg client message
     * @param {Function} cb callback function
     * @api public
     */
    monitorHandler(agent, msg, cb) {
        if (!msg.logfile) {
            cb(new Error("logfile should not be empty"));
            return;
        }
        let serverId = agent.id;
        fetchLogs(this.root, msg, (data) => {
            cb(null, { serverId: serverId, body: data });
        });
    }
    /**
     * Handle client request
     *
     * @param {Object} agent masterAgent object
     * @param {Object} msg client message
     * @param {Function} cb callback function
     * @api public
     */
    clientHandler(agent, msg, cb) {
        agent.request(msg.serverId, module.exports.moduleId, msg, (err, res) => {
            if (err) {
                logger.error("fail to run log for " + err.stack);
                return;
            }
            cb(null, res);
        });
    }
}
//get the latest logs
function fetchLogs(root, msg, callback) {
    let number = msg.number;
    let logfile = msg.logfile;
    let serverId = msg.serverId;
    let filePath = path.join(root, getLogFileName(logfile, serverId));
    let endLogs = [];
    exec("tail -n " + number + " " + filePath, (error, output) => {
        let endOut = [];
        output = output.replace(/^\s+|\s+$/g, "").split(/\s+/);
        for (let i = 5; i < output.length; i += 6) {
            endOut.push(output[i]);
        }
        let endLength = endOut.length;
        for (let j = 0; j < endLength; j++) {
            let map = {};
            let json;
            try {
                json = JSON.parse(endOut[j]);
            }
            catch (e) {
                logger.error("the log cannot parsed to json, " + e);
                continue;
            }
            map.time = json.time;
            map.route = json.route || json.service;
            map.serverId = serverId;
            map.timeUsed = json.timeUsed;
            map.params = endOut[j];
            endLogs.push(map);
        }
        callback({ logfile: logfile, dataArray: endLogs });
    });
}
function getLogFileName(logfile, serverId) {
    return logfile + "-" + serverId + ".log";
}
module.exports = (opts) => {
    return new MonitorLogModule(opts);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uaXRvckxvZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1vbml0b3JMb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7QUFDSCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM5RSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQzNDLDZCQUE4QjtBQUk5QixNQUFNLGdCQUFnQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxZQUFZO0FBTTdDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLFlBQVksQ0FBQztBQUV2QztJQUdDOzs7Ozs7O09BT0c7SUFDSCxZQUFZLElBQVM7UUFDcEIsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxnQkFBZ0IsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILGNBQWMsQ0FBQyxLQUFtQixFQUFFLEdBQVEsRUFBRSxFQUFZO1FBQ3pELEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbEIsRUFBRSxDQUFDLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUM7UUFDUixDQUFDO1FBRUQsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUN4QixTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRTtZQUN2QyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFB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LFFBQVEsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsd0JBQXdCLE9BQWUsRUFBRSxRQUFnQjtJQUN4RCxNQUFNLENBQUMsT0FBTyxHQUFHLEdBQUcsR0FBRyxRQUFRLEdBQUcsTUFBTSxDQUFDO0FBQzFDLENBQUM7QUExR0QsaUJBQVMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtJQUN0QixNQUFNLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNuQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIFBvbWVsbyAtLSBjb25zb2xlTW9kdWxlIG1vbml0b3JMb2dcbiAqIENvcHlyaWdodChjKSAyMDEyIGZhbnRhc3luaSA8ZmFudGFzeW5pQDE2My5jb20+XG4gKiBNSVQgTGljZW5zZWRcbiAqL1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvLWFkbWluXCIsIF9fZmlsZW5hbWUpO1xuY29uc3QgZXhlYyA9IHJlcXVpcmUoXCJjaGlsZF9wcm9jZXNzXCIpLmV4ZWM7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuaW1wb3J0IHsgTW9uaXRvckFnZW50IH0gZnJvbSBcIi4uL21vbml0b3IvbW9uaXRvckFnZW50XCI7XG5pbXBvcnQgeyBNYXN0ZXJBZ2VudCB9IGZyb20gXCIuLi9tYXN0ZXIvbWFzdGVyQWdlbnRcIjtcblxuY29uc3QgREVGQVVMVF9JTlRFUlZBTCA9IDUgKiA2MDsgLy8gaW4gc2Vjb25kXG5cbmV4cG9ydCA9IChvcHRzOiBhbnkpID0+IHtcblx0cmV0dXJuIG5ldyBNb25pdG9yTG9nTW9kdWxlKG9wdHMpO1xufTtcblxubW9kdWxlLmV4cG9ydHMubW9kdWxlSWQgPSBcIm1vbml0b3JMb2dcIjtcblxuY2xhc3MgTW9uaXRvckxvZ01vZHVsZSB7XG5cdHJlYWRvbmx5IHJvb3Q6IHN0cmluZztcblx0cmVhZG9ubHkgaW50ZXJ2YWw6IG51bWJlcjtcblx0LyoqXG5cdCAqIEluaXRpYWxpemUgYSBuZXcgJ01vZHVsZScgd2l0aCB0aGUgZ2l2ZW4gJ29wdHMnXG5cdCAqXG5cdCAqIEBjbGFzcyBNb2R1bGVcblx0ICogQGNvbnN0cnVjdG9yXG5cdCAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzXG5cdCAqIEBhcGkgcHVibGljXG5cdCAqL1xuXHRjb25zdHJ1Y3RvcihvcHRzOiBhbnkpIHtcblx0XHRvcHRzID0gb3B0cyB8fCB7fTtcblx0XHR0aGlzLnJvb3QgPSBvcHRzLnBhdGg7XG5cdFx0dGhpcy5pbnRlcnZhbCA9IG9wdHMuaW50ZXJ2YWwgfHwgREVGQVVMVF9JTlRFUlZBTDtcblx0fVxuXG5cdC8qKlxuXHQgKiBjb2xsZWN0IG1vbml0b3IgZGF0YSBmcm9tIG1vbml0b3Jcblx0ICpcblx0ICogQHBhcmFtIHtPYmplY3R9IGFnZW50IG1vbml0b3JBZ2VudCBvYmplY3Rcblx0ICogQHBhcmFtIHtPYmplY3R9IG1zZyBjbGllbnQgbWVzc2FnZVxuXHQgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYiBjYWxsYmFjayBmdW5jdGlvblxuXHQgKiBAYXBpIHB1YmxpY1xuXHQgKi9cblx0bW9uaXRvckhhbmRsZXIoYWdlbnQ6IE1vbml0b3JBZ2VudCwgbXNnOiBhbnksIGNiOiBGdW5jdGlvbikge1xuXHRcdGlmICghbXNnLmxvZ2ZpbGUpIHtcblx0XHRcdGNiKG5ldyBFcnJvcihcImxvZ2ZpbGUgc2hvdWxkIG5vdCBiZSBlbXB0eVwiKSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0bGV0IHNlcnZlcklkID0gYWdlbnQuaWQ7XG5cdFx0ZmV0Y2hMb2dzKHRoaXMucm9vdCwgbXNnLCAoZGF0YTogYW55KSA9PiB7XG5cdFx0XHRjYihudWxsLCB7IHNlcnZlcklkOiBzZXJ2ZXJJZCwgYm9keTogZGF0YSB9KTtcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBIYW5kbGUgY2xpZW50IHJlcXVlc3Rcblx0ICpcblx0ICogQHBhcmFtIHtPYmplY3R9IGFnZW50IG1hc3RlckFnZW50IG9iamVjdFxuXHQgKiBAcGFyYW0ge09iamVjdH0gbXNnIGNsaWVudCBtZXNzYWdlXG5cdCAqIEBwYXJhbSB7RnVuY3Rpb259IGNiIGNhbGxiYWNrIGZ1bmN0aW9uXG5cdCAqIEBhcGkgcHVibGljXG5cdCAqL1xuXHRjbGllbnRIYW5kbGVyKGFnZW50OiBNYXN0ZXJBZ2VudCwgbXNnOiBhbnksIGNiOiBGdW5jdGlvbikge1xuXHRcdGFnZW50LnJlcXVlc3QoXG5cdFx0XHRtc2cuc2VydmVySWQsXG5cdFx0XHRtb2R1bGUuZXhwb3J0cy5tb2R1bGVJZCxcblx0XHRcdG1zZyxcblx0XHRcdChlcnI6IGFueSwgcmVzOiBhbnkpID0+IHtcblx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdGxvZ2dlci5lcnJvcihcImZhaWwgdG8gcnVuIGxvZyBmb3IgXCIgKyBlcnIuc3RhY2spO1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXHRcdFx0XHRjYihudWxsLCByZXMpO1xuXHRcdFx0fVxuXHRcdCk7XG5cdH1cbn1cbi8vZ2V0IHRoZSBsYXRlc3QgbG9nc1xuZnVuY3Rpb24gZmV0Y2hMb2dzKHJvb3Q6IHN0cmluZywgbXNnOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikge1xuXHRsZXQgbnVtYmVyID0gbXNnLm51bWJlcjtcblx0bGV0IGxvZ2ZpbGUgPSBtc2cubG9nZmlsZTtcblx0bGV0IHNlcnZlcklkID0gbXNnLnNlcnZlcklkO1xuXHRsZXQgZmlsZVBhdGggPSBwYXRoLmpvaW4ocm9vdCwgZ2V0TG9nRmlsZU5hbWUobG9nZmlsZSwgc2VydmVySWQpKTtcblxuXHRsZXQgZW5kTG9nczogYW55ID0gW107XG5cdGV4ZWMoXCJ0YWlsIC1uIFwiICsgbnVtYmVyICsgXCIgXCIgKyBmaWxlUGF0aCwgKGVycm9yOiBhbnksIG91dHB1dDogYW55KSA9PiB7XG5cdFx0bGV0IGVuZE91dCA9IFtdO1xuXHRcdG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9eXFxzK3xcXHMrJC9nLCBcIlwiKS5zcGxpdCgvXFxzKy8pO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDU7IGkgPCBvdXRwdXQubGVuZ3RoOyBpICs9IDYpIHtcblx0XHRcdGVuZE91dC5wdXNoKG91dHB1dFtpXSk7XG5cdFx0fVxuXG5cdFx0bGV0IGVuZExlbmd0aCA9IGVuZE91dC5sZW5ndGg7XG5cdFx0Zm9yIChsZXQgaiA9IDA7IGogPCBlbmRMZW5ndGg7IGorKykge1xuXHRcdFx0bGV0IG1hcDogYW55ID0ge307XG5cdFx0XHRsZXQganNvbjtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGpzb24gPSBKU09OLnBhcnNlKGVuZE91dFtqXSk7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihcInRoZSBsb2cgY2Fubm90IHBhcnNlZCB0byBqc29uLCBcIiArIGUpO1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblx0XHRcdG1hcC50aW1lID0ganNvbi50aW1lO1xuXHRcdFx0bWFwLnJvdXRlID0ganNvbi5yb3V0ZSB8fCBqc29uLnNlcnZpY2U7XG5cdFx0XHRtYXAuc2VydmVySWQgPSBzZXJ2ZXJJZDtcblx0XHRcdG1hcC50aW1lVXNlZCA9IGpzb24udGltZVVzZWQ7XG5cdFx0XHRtYXAucGFyYW1zID0gZW5kT3V0W2pdO1xuXHRcdFx0ZW5kTG9ncy5wdXNoKG1hcCk7XG5cdFx0fVxuXG5cdFx0Y2FsbGJhY2soeyBsb2dmaWxlOiBsb2dmaWxlLCBkYXRhQXJyYXk6IGVuZExvZ3MgfSk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBnZXRMb2dGaWxlTmFtZShsb2dmaWxlOiBzdHJpbmcsIHNlcnZlcklkOiBzdHJpbmcpIHtcblx0cmV0dXJuIGxvZ2ZpbGUgKyBcIi1cIiArIHNlcnZlcklkICsgXCIubG9nXCI7XG59XG4iXX0=