"use strict";
const monitor = require("pomelo-monitor");
const logger = require("pomelo-logger").getLogger("pomelo-admin", __filename);
let DEFAULT_INTERVAL = 5 * 60; // in second
let DEFAULT_DELAY = 10; // in second
module.exports.moduleId = "nodeInfo";
class NetInfoModule {
    constructor(opts) {
        opts = opts || {};
        this.type = opts.type || "pull";
        this.interval = opts.interval || DEFAULT_INTERVAL;
        this.delay = opts.delay || DEFAULT_DELAY;
    }
    monitorHandler(agent, msg, cb) {
        let serverId = agent.id;
        let pid = process.pid;
        let params = {
            serverId: serverId,
            pid: pid
        };
        monitor.psmonitor.getPsInfo(params, (err, data) => {
            agent.notify(module.exports.moduleId, {
                serverId: agent.id,
                body: data
            });
        });
    }
    masterHandler(agent, msg, cb) {
        if (!msg) {
            agent.notifyAll(module.exports.moduleId);
            return;
        }
        let body = msg.body;
        let data = agent.get(module.exports.moduleId);
        if (!data) {
            data = {};
            agent.set(module.exports.moduleId, data);
        }
        data[msg.serverId] = body;
    }
    clientHandler(agent, msg, cb) {
        cb(null, agent.get(module.exports.moduleId) || {});
    }
}
module.exports = (opts) => {
    return new NetInfoModule(opts);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZUluZm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJub2RlSW5mby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBUUEsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDMUMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFOUUsSUFBSSxnQkFBZ0IsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsWUFBWTtBQUMzQyxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUMsQ0FBQyxZQUFZO0FBTXBDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztBQUVyQztJQUlDLFlBQVksSUFBUztRQUNwQixJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxnQkFBZ0IsQ0FBQztRQUNsRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksYUFBYSxDQUFDO0lBQzFDLENBQUM7SUFFRCxjQUFjLENBQUMsS0FBbUIsRUFBRSxHQUFRLEVBQUUsRUFBWTtRQUN6RCxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3hCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFDdEIsSUFBSSxNQUFNLEdBQUc7WUFDWixRQUFRLEVBQUUsUUFBUTtZQUNsQixHQUFHLEVBQUUsR0FBRztTQUNSLENBQUM7UUFDRixPQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFRLEVBQUUsSUFBUyxFQUFFLEVBQUU7WUFDM0QsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtnQkFDckMsUUFBUSxFQUFFLEtBQUssQ0FBQyxFQUFFO2dCQUNsQixJQUFJLEVBQUUsSUFBSTthQUNWLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELGFBQWEsQ0FBQyxLQUFrQixFQUFFLEdBQVEsRUFBRSxFQUFZO1FBQ3ZELEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNWLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN6QyxNQUFNLENBQUM7UUFDUixDQUFDO1FBRUQsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNwQixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDOUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNWLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUVELElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQzNCLENBQUM7SUFFRCxhQUFhLENBQUMsS0FBa0IsRUFBRSxHQUFRLEVBQUUsRUFBWTtRQUN2RCxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNwRCxDQUFDO0NBQ0Q7QUFuREQsaUJBQVMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtJQUN0QixNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBQb21lbG8gLS0gY29uc29sZU1vZHVsZSBub2RlSW5mbyBwcm9jZXNzSW5mb1xuICogQ29weXJpZ2h0KGMpIDIwMTIgZmFudGFzeW5pIDxmYW50YXN5bmlAMTYzLmNvbT5cbiAqIE1JVCBMaWNlbnNlZFxuICovXG5pbXBvcnQgeyBNb25pdG9yQWdlbnQgfSBmcm9tIFwiLi4vbW9uaXRvci9tb25pdG9yQWdlbnRcIjtcbmltcG9ydCB7IE1hc3RlckFnZW50IH0gZnJvbSBcIi4uL21hc3Rlci9tYXN0ZXJBZ2VudFwiO1xuXG5jb25zdCBtb25pdG9yID0gcmVxdWlyZShcInBvbWVsby1tb25pdG9yXCIpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvLWFkbWluXCIsIF9fZmlsZW5hbWUpO1xuXG5sZXQgREVGQVVMVF9JTlRFUlZBTCA9IDUgKiA2MDsgLy8gaW4gc2Vjb25kXG5sZXQgREVGQVVMVF9ERUxBWSA9IDEwOyAvLyBpbiBzZWNvbmRcblxuZXhwb3J0ID0gKG9wdHM6IGFueSkgPT4ge1xuXHRyZXR1cm4gbmV3IE5ldEluZm9Nb2R1bGUob3B0cyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5tb2R1bGVJZCA9IFwibm9kZUluZm9cIjtcblxuY2xhc3MgTmV0SW5mb01vZHVsZSB7XG5cdHByaXZhdGUgdHlwZTogc3RyaW5nO1xuXHRwcml2YXRlIGludGVydmFsOiBudW1iZXI7XG5cdHByaXZhdGUgZGVsYXk6IG51bWJlcjtcblx0Y29uc3RydWN0b3Iob3B0czogYW55KSB7XG5cdFx0b3B0cyA9IG9wdHMgfHwge307XG5cdFx0dGhpcy50eXBlID0gb3B0cy50eXBlIHx8IFwicHVsbFwiO1xuXHRcdHRoaXMuaW50ZXJ2YWwgPSBvcHRzLmludGVydmFsIHx8IERFRkFVTFRfSU5URVJWQUw7XG5cdFx0dGhpcy5kZWxheSA9IG9wdHMuZGVsYXkgfHwgREVGQVVMVF9ERUxBWTtcblx0fVxuXG5cdG1vbml0b3JIYW5kbGVyKGFnZW50OiBNb25pdG9yQWdlbnQsIG1zZzogYW55LCBjYjogRnVuY3Rpb24pIHtcblx0XHRsZXQgc2VydmVySWQgPSBhZ2VudC5pZDtcblx0XHRsZXQgcGlkID0gcHJvY2Vzcy5waWQ7XG5cdFx0bGV0IHBhcmFtcyA9IHtcblx0XHRcdHNlcnZlcklkOiBzZXJ2ZXJJZCxcblx0XHRcdHBpZDogcGlkXG5cdFx0fTtcblx0XHRtb25pdG9yLnBzbW9uaXRvci5nZXRQc0luZm8ocGFyYW1zLCAoZXJyOiBhbnksIGRhdGE6IGFueSkgPT4ge1xuXHRcdFx0YWdlbnQubm90aWZ5KG1vZHVsZS5leHBvcnRzLm1vZHVsZUlkLCB7XG5cdFx0XHRcdHNlcnZlcklkOiBhZ2VudC5pZCxcblx0XHRcdFx0Ym9keTogZGF0YVxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRtYXN0ZXJIYW5kbGVyKGFnZW50OiBNYXN0ZXJBZ2VudCwgbXNnOiBhbnksIGNiOiBGdW5jdGlvbikge1xuXHRcdGlmICghbXNnKSB7XG5cdFx0XHRhZ2VudC5ub3RpZnlBbGwobW9kdWxlLmV4cG9ydHMubW9kdWxlSWQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCBib2R5ID0gbXNnLmJvZHk7XG5cdFx0bGV0IGRhdGEgPSBhZ2VudC5nZXQobW9kdWxlLmV4cG9ydHMubW9kdWxlSWQpO1xuXHRcdGlmICghZGF0YSkge1xuXHRcdFx0ZGF0YSA9IHt9O1xuXHRcdFx0YWdlbnQuc2V0KG1vZHVsZS5leHBvcnRzLm1vZHVsZUlkLCBkYXRhKTtcblx0XHR9XG5cblx0XHRkYXRhW21zZy5zZXJ2ZXJJZF0gPSBib2R5O1xuXHR9XG5cblx0Y2xpZW50SGFuZGxlcihhZ2VudDogTWFzdGVyQWdlbnQsIG1zZzogYW55LCBjYjogRnVuY3Rpb24pIHtcblx0XHRjYihudWxsLCBhZ2VudC5nZXQobW9kdWxlLmV4cG9ydHMubW9kdWxlSWQpIHx8IHt9KTtcblx0fVxufVxuIl19