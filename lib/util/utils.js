"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crypto = require("crypto");
const path = require("path");
const fs = require("fs");
/**
 * Check and invoke callback
 */
function invokeCallback(cb, ...args) {
    if (!!cb && typeof cb === "function") {
        cb.apply(null, Array.prototype.slice.call(arguments, 1));
    }
}
exports.invokeCallback = invokeCallback;
/*
 * Date format
 */
function format(date, format) {
    format = format || "MM-dd-hhmm";
    let o = {
        "M+": date.getMonth() + 1,
        "d+": date.getDate(),
        "h+": date.getHours(),
        "m+": date.getMinutes(),
        "s+": date.getSeconds(),
        "q+": Math.floor((date.getMonth() + 3) / 3),
        S: date.getMilliseconds() //millisecond
    };
    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (let k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length === 1
                ? o[k]
                : ("00" + o[k]).substr(("" + o[k]).length));
        }
    }
    return format;
}
exports.format = format;
function compareServer(server1, server2) {
    return server1.host === server2.host && server1.port === server2.port;
}
exports.compareServer = compareServer;
/**
 * Get the count of elements of object
 */
function size(obj, type) {
    let count = 0;
    for (let i in obj) {
        if (obj.hasOwnProperty(i) && typeof obj[i] !== "function") {
            if (!type) {
                count++;
                continue;
            }
            if (type && type === obj[i]["type"]) {
                count++;
            }
        }
    }
    return count;
}
exports.size = size;
function md5(str) {
    let md5sum = crypto.createHash("md5");
    md5sum.update(str);
    str = md5sum.digest("hex");
    return str;
}
exports.md5 = md5;
function defaultAuthUser(msg, env, cb) {
    let adminUser = null;
    let appBase = path.dirname(require.main.filename);
    let adminUserPath = path.join(appBase, "/config/adminUser.json");
    let presentPath = path.join(appBase, "config", env, "adminUser.json");
    if (fs.existsSync(adminUserPath)) {
        adminUser = require(adminUserPath);
    }
    else if (fs.existsSync(presentPath)) {
        adminUser = require(presentPath);
    }
    else {
        cb(null);
        return;
    }
    let username = msg["username"];
    let password = msg["password"];
    let md5 = msg["md5"];
    let len = adminUser.length;
    if (md5) {
        for (let i = 0; i < len; i++) {
            let user = adminUser[i];
            let p = "";
            if (user["username"] === username) {
                p = md5(user["password"]);
                if (password === p) {
                    cb(user);
                    return;
                }
            }
        }
    }
    else {
        for (let i = 0; i < len; i++) {
            let user = adminUser[i];
            if (user["username"] === username &&
                user["password"] === password) {
                cb(user);
                return;
            }
        }
    }
    cb(null);
}
exports.defaultAuthUser = defaultAuthUser;
function defaultAuthServerMaster(msg, env, cb) {
    let id = msg["id"];
    let type = msg["serverType"];
    let token = msg["token"];
    if (type === "master") {
        cb("ok");
        return;
    }
    let servers = null;
    let appBase = path.dirname(require.main.filename);
    let serverPath = path.join(appBase, "/config/adminServer.json");
    let presentPath = null;
    if (env) {
        presentPath = path.join(appBase, "config", env, "adminServer.json");
    }
    if (fs.existsSync(serverPath)) {
        servers = require(serverPath);
    }
    else if (fs.existsSync(presentPath)) {
        servers = require(presentPath);
    }
    else {
        cb("ok");
        return;
    }
    let len = servers.length;
    for (let i = 0; i < len; i++) {
        let server = servers[i];
        if (server["type"] === type && server["token"] === token) {
            cb("ok");
            return;
        }
    }
    cb("bad");
    return;
}
exports.defaultAuthServerMaster = defaultAuthServerMaster;
function defaultAuthServerMonitor(msg, env, cb) {
    let id = msg["id"];
    let type = msg["serverType"];
    let servers = null;
    let appBase = path.dirname(require.main.filename);
    let serverPath = path.join(appBase, "/config/adminServer.json");
    let presentPath = null;
    if (env) {
        presentPath = path.join(appBase, "config", env, "adminServer.json");
    }
    if (fs.existsSync(serverPath)) {
        servers = require(serverPath);
    }
    else if (fs.existsSync(presentPath)) {
        servers = require(presentPath);
    }
    else {
        cb("ok");
        return;
    }
    let len = servers.length;
    for (let i = 0; i < len; i++) {
        let server = servers[i];
        if (server["type"] === type) {
            cb(server["token"]);
            return;
        }
    }
    cb(null);
    return;
}
exports.defaultAuthServerMonitor = defaultAuthServerMonitor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGlDQUFrQztBQUVsQyw2QkFBOEI7QUFDOUIseUJBQTBCO0FBRTFCOztHQUVHO0FBQ0gsd0JBQStCLEVBQVksRUFBRSxHQUFHLElBQVc7SUFDMUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxPQUFPLEVBQUUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRCxDQUFDO0FBQ0YsQ0FBQztBQUpELHdDQUlDO0FBRUQ7O0dBRUc7QUFDSCxnQkFBdUIsSUFBVSxFQUFFLE1BQWU7SUFDakQsTUFBTSxHQUFHLE1BQU0sSUFBSSxZQUFZLENBQUM7SUFDaEMsSUFBSSxDQUFDLEdBQVE7UUFDWixJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUM7UUFDekIsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDcEIsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUU7UUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLENBQUMsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsYUFBYTtLQUN2QyxDQUFDO0lBRUYsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsTUFBTSxH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QUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQzlCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUM3QixFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxDQUFDO1FBQ1IsQ0FBQztJQUNGLENBQUM7SUFDRCxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDVCxNQUFNLENBQUM7QUFDUixDQUFDO0FBL0JELDREQStCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlcnZlckluZm8sIFNsYXZlUmVjb3JkIH0gZnJvbSBcIi4uLy4uL2luZGV4XCI7XG5pbXBvcnQgY3J5cHRvID0gcmVxdWlyZShcImNyeXB0b1wiKTtcbmltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG4vKipcbiAqIENoZWNrIGFuZCBpbnZva2UgY2FsbGJhY2tcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGludm9rZUNhbGxiYWNrKGNiOiBGdW5jdGlvbiwgLi4uYXJnczogYW55W10pIHtcblx0aWYgKCEhY2IgJiYgdHlwZW9mIGNiID09PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRjYi5hcHBseShudWxsLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTtcblx0fVxufVxuXG4vKlxuICogRGF0ZSBmb3JtYXRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdChkYXRlOiBEYXRlLCBmb3JtYXQ/OiBzdHJpbmcpIHtcblx0Zm9ybWF0ID0gZm9ybWF0IHx8IFwiTU0tZGQtaGhtbVwiO1xuXHRsZXQgbzogYW55ID0ge1xuXHRcdFwiTStcIjogZGF0ZS5nZXRNb250aCgpICsgMSwgLy9tb250aFxuXHRcdFwiZCtcIjogZGF0ZS5nZXREYXRlKCksIC8vZGF5XG5cdFx0XCJoK1wiOiBkYXRlLmdldEhvdXJzKCksIC8vaG91clxuXHRcdFwibStcIjogZGF0ZS5nZXRNaW51dGVzKCksIC8vbWludXRlXG5cdFx0XCJzK1wiOiBkYXRlLmdldFNlY29uZHMoKSwgLy9zZWNvbmRcblx0XHRcInErXCI6IE1hdGguZmxvb3IoKGRhdGUuZ2V0TW9udGgoKSArIDMpIC8gMyksIC8vcXVhcnRlclxuXHRcdFM6IGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCkgLy9taWxsaXNlY29uZFxuXHR9O1xuXG5cdGlmICgvKHkrKS8udGVzdChmb3JtYXQpKSB7XG5cdFx0Zm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UoXG5cdFx0XHRSZWdFeHAuJDEsXG5cdFx0XHQoZGF0ZS5nZXRGdWxsWWVhcigpICsgXCJcIikuc3Vic3RyKDQgLSBSZWdFeHAuJDEubGVuZ3RoKVxuXHRcdCk7XG5cdH1cblx0Zm9yIChsZXQgayBpbiBvKSB7XG5cdFx0aWYgKG5ldyBSZWdFeHAoXCIoXCIgKyBrICsgXCIpXCIpLnRlc3QoZm9ybWF0KSkge1xuXHRcdFx0Zm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UoXG5cdFx0XHRcdFJlZ0V4cC4kMSxcblx0XHRcdFx0UmVnRXhwLiQxLmxlbmd0aCA9PT0gMVxuXHRcdFx0XHRcdD8gb1trXVxuXHRcdFx0XHRcdDogKFwiMDBcIiArIG9ba10pLnN1YnN0cigoXCJcIiArIG9ba10pLmxlbmd0aClcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGZvcm1hdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBhcmVTZXJ2ZXIoXG5cdHNlcnZlcjE6IFNlcnZlckluZm8gfCBTbGF2ZVJlY29yZCxcblx0c2VydmVyMjogU2VydmVySW5mbyB8IFNsYXZlUmVjb3JkXG4pIHtcblx0cmV0dXJuIHNlcnZlcjEuaG9zdCA9PT0gc2VydmVyMi5ob3N0ICYmIHNlcnZlcjEucG9ydCA9PT0gc2VydmVyMi5wb3J0O1xufVxuXG4vKipcbiAqIEdldCB0aGUgY291bnQgb2YgZWxlbWVudHMgb2Ygb2JqZWN0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzaXplKG9iajogYW55LCB0eXBlPzogc3RyaW5nKSB7XG5cdGxldCBjb3VudCA9IDA7XG5cdGZvciAobGV0IGkgaW4gb2JqKSB7XG5cdFx0aWYgKG9iai5oYXNPd25Qcm9wZXJ0eShpKSAmJiB0eXBlb2Ygb2JqW2ldICE9PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRcdGlmICghdHlwZSkge1xuXHRcdFx0XHRjb3VudCsrO1xuXHRcdFx0XHRjb250aW51ZTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHR5cGUgJiYgdHlwZSA9PT0gb2JqW2ldW1widHlwZVwiXSkge1xuXHRcdFx0XHRjb3VudCsrO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXHRyZXR1cm4gY291bnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZDUoc3RyOiBzdHJpbmcpIHtcblx0bGV0IG1kNXN1bSA9IGNyeXB0by5jcmVhdGVIYXNoKFwibWQ1XCIpO1xuXHRtZDVzdW0udXBkYXRlKHN0cik7XG5cdHN0ciA9IG1kNXN1bS5kaWdlc3QoXCJoZXhcIik7XG5cdHJldHVybiBzdHI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZhdWx0QXV0aFVzZXIobXNnOiBhbnksIGVudjogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcblx0bGV0IGFkbWluVXNlciA9IG51bGw7XG5cdGxldCBhcHBCYXNlID0gcGF0aC5kaXJuYW1lKCg8YW55PnJlcXVpcmUpLm1haW4uZmlsZW5hbWUpO1xuXHRsZXQgYWRtaW5Vc2VyUGF0aCA9IHBhdGguam9pbihhcHBCYXNlLCBcIi9jb25maWcvYWRtaW5Vc2VyLmpzb25cIik7XG5cdGxldCBwcmVzZW50UGF0aCA9IHBhdGguam9pbihhcHBCYXNlLCBcImNvbmZpZ1wiLCBlbnYsIFwiYWRtaW5Vc2VyLmpzb25cIik7XG5cdGlmIChmcy5leGlzdHNTeW5jKGFkbWluVXNlclBhdGgpKSB7XG5cdFx0YWRtaW5Vc2VyID0gcmVxdWlyZShhZG1pblVzZXJQYXRoKTtcblx0fSBlbHNlIGlmIChmcy5leGlzdHNTeW5jKHByZXNlbnRQYXRoKSkge1xuXHRcdGFkbWluVXNlciA9IHJlcXVpcmUocHJlc2VudFBhdGgpO1xuXHR9IGVsc2Uge1xuXHRcdGNiKG51bGwpO1xuXHRcdHJldHVybjtcblx0fVxuXHRsZXQgdXNlcm5hbWUgPSBtc2dbXCJ1c2VybmFtZVwiXTtcblx0bGV0IHBhc3N3b3JkID0gbXNnW1wicGFzc3dvcmRcIl07XG5cdGxldCBtZDUgPSBtc2dbXCJtZDVcIl07XG5cblx0bGV0IGxlbiA9IGFkbWluVXNlci5sZW5ndGg7XG5cdGlmIChtZDUpIHtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRsZXQgdXNlciA9IGFkbWluVXNlcltpXTtcblx0XHRcdGxldCBwID0gXCJcIjtcblx0XHRcdGlmICh1c2VyW1widXNlcm5hbWVcIl0gPT09IHVzZXJuYW1lKSB7XG5cdFx0XHRcdHAgPSBtZDUodXNlcltcInBhc3N3b3JkXCJdKTtcblx0XHRcdFx0aWYgKHBhc3N3b3JkID09PSBwKSB7XG5cdFx0XHRcdFx0Y2IodXNlcik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcblx0XHRcdGxldCB1c2VyID0gYWRtaW5Vc2VyW2ldO1xuXHRcdFx0aWYgKFxuXHRcdFx0XHR1c2VyW1widXNlcm5hbWVcIl0gPT09IHVzZXJuYW1lICYmXG5cdFx0XHRcdHVzZXJbXCJwYXNzd29yZFwiXSA9PT0gcGFzc3dvcmRcblx0XHRcdCkge1xuXHRcdFx0XHRjYih1c2VyKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXHRjYihudWxsKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRBdXRoU2VydmVyTWFzdGVyKG1zZzogYW55LCBlbnY6IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XG5cdGxldCBpZCA9IG1zZ1tcImlkXCJdO1xuXHRsZXQgdHlwZSA9IG1zZ1tcInNlcnZlclR5cGVcIl07XG5cdGxldCB0b2tlbiA9IG1zZ1tcInRva2VuXCJdO1xuXHRpZiAodHlwZSA9PT0gXCJtYXN0ZXJcIikge1xuXHRcdGNiKFwib2tcIik7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0bGV0IHNlcnZlcnMgPSBudWxsO1xuXHRsZXQgYXBwQmFzZSA9IHBhdGguZGlybmFtZSgoPGFueT5yZXF1aXJlKS5tYWluLmZpbGVuYW1lKTtcblx0bGV0IHNlcnZlclBhdGggPSBwYXRoLmpvaW4oYXBwQmFzZSwgXCIvY29uZmlnL2FkbWluU2VydmVyLmpzb25cIik7XG5cdGxldCBwcmVzZW50UGF0aCA9IG51bGw7XG5cdGlmIChlbnYpIHtcblx0XHRwcmVzZW50UGF0aCA9IHBhdGguam9pbihhcHBCYXNlLCBcImNvbmZpZ1wiLCBlbnYsIFwiYWRtaW5TZXJ2ZXIuanNvblwiKTtcblx0fVxuXG5cdGlmIChmcy5leGlzdHNTeW5jKHNlcnZlclBhdGgpKSB7XG5cdFx0c2VydmVycyA9IHJlcXVpcmUoc2VydmVyUGF0aCk7XG5cdH0gZWxzZSBpZiAoZnMuZXhpc3RzU3luYyhwcmVzZW50UGF0aCEpKSB7XG5cdFx0c2VydmVycyA9IHJlcXVpcmUocHJlc2VudFBhdGghKTtcblx0fSBlbHNlIHtcblx0XHRjYihcIm9rXCIpO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGxldCBsZW4gPSBzZXJ2ZXJzLmxlbmd0aDtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdGxldCBzZXJ2ZXIgPSBzZXJ2ZXJzW2ldO1xuXHRcdGlmIChzZXJ2ZXJbXCJ0eXBlXCJdID09PSB0eXBlICYmIHNlcnZlcltcInRva2VuXCJdID09PSB0b2tlbikge1xuXHRcdFx0Y2IoXCJva1wiKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdH1cblx0Y2IoXCJiYWRcIik7XG5cdHJldHVybjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZmF1bHRBdXRoU2VydmVyTW9uaXRvcihtc2c6IGFueSwgZW52OiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuXHRsZXQgaWQgPSBtc2dbXCJpZFwiXTtcblx0bGV0IHR5cGUgPSBtc2dbXCJzZXJ2ZXJUeXBlXCJdO1xuXG5cdGxldCBzZXJ2ZXJzID0gbnVsbDtcblx0bGV0IGFwcEJhc2UgPSBwYXRoLmRpcm5hbWUoKDxhbnk+cmVxdWlyZSkubWFpbi5maWxlbmFtZSk7XG5cdGxldCBzZXJ2ZXJQYXRoID0gcGF0aC5qb2luKGFwcEJhc2UsIFwiL2NvbmZpZy9hZG1pblNlcnZlci5qc29uXCIpO1xuXHRsZXQgcHJlc2VudFBhdGggPSBudWxsO1xuXHRpZiAoZW52KSB7XG5cdFx0cHJlc2VudFBhdGggPSBwYXRoLmpvaW4oYXBwQmFzZSwgXCJjb25maWdcIiwgZW52LCBcImFkbWluU2VydmVyLmpzb25cIik7XG5cdH1cblxuXHRpZiAoZnMuZXhpc3RzU3luYyhzZXJ2ZXJQYXRoKSkge1xuXHRcdHNlcnZlcnMgPSByZXF1aXJlKHNlcnZlclBhdGgpO1xuXHR9IGVsc2UgaWYgKGZzLmV4aXN0c1N5bmMocHJlc2VudFBhdGghKSkge1xuXHRcdHNlcnZlcnMgPSByZXF1aXJlKHByZXNlbnRQYXRoISk7XG5cdH0gZWxzZSB7XG5cdFx0Y2IoXCJva1wiKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRsZXQgbGVuID0gc2VydmVycy5sZW5ndGg7XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcblx0XHRsZXQgc2VydmVyID0gc2VydmVyc1tpXTtcblx0XHRpZiAoc2VydmVyW1widHlwZVwiXSA9PT0gdHlwZSkge1xuXHRcdFx0Y2Ioc2VydmVyW1widG9rZW5cIl0pO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0fVxuXHRjYihudWxsKTtcblx0cmV0dXJuO1xufVxuIl19