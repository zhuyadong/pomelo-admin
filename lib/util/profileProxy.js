"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const HeapProfileType = "HEAP";
const CPUProfileType = "CPU";
class ProfileProxy {
    constructor() {
        this.profiles = {
            HEAP: {},
            CPU: {}
        };
        this.isProfilingCPU = false;
    }
    enable(id, params, clientId, agent) {
        this.sendResult(id, {
            result: true
        }, clientId, agent);
    }
    causesRecompilation(id, params, clientId, agent) {
        this.sendResult(id, {
            result: false
        }, clientId, agent);
    }
    isSampling(id, params, clientId, agent) {
        this.sendResult(id, {
            result: true
        }, clientId, agent);
    }
    hasHeapProfiler(id, params, clientId, agent) {
        this.sendResult(id, {
            result: true
        }, clientId, agent);
    }
    getProfileHeaders(id, params, clientId, agent) {
        let headers = [];
        for (let type in this.profiles) {
            for (let profileId in this.profiles[type]) {
                let profile = this.profiles[type][profileId];
                headers.push({
                    title: profile.title,
                    uid: profile.uid,
                    typeId: type
                });
            }
        }
        this.sendResult(id, {
            headers: headers
        }, clientId, agent);
    }
    takeHeapSnapshot(id, params, clientId, agent) {
        let uid = params.uid;
        agent.notifyById(uid, "profiler", {
            type: "heap",
            action: "start",
            uid: uid,
            clientId: clientId
        });
        this.sendEvent({
            method: "Profiler.addProfileHeader",
            params: {
                header: { title: uid, uid: uid, typeId: HeapProfileType }
            }
        }, clientId, agent);
        this.sendResult(id, {}, clientId, agent);
    }
    takeSnapCallBack(data) {
        let uid = data.params.uid || 0;
        let snapShot = this.profiles[HeapProfileType][uid];
        if (!snapShot || snapShot.finish) {
            snapShot = {
                data: [],
                finish: false,
                uid: uid,
                title: uid
            };
        }
        if (data.method === "Profiler.addHeapSnapshotChunk") {
            let chunk = data.params.chunk;
            snapShot.data.push(chunk);
        }
        else {
            snapShot.finish = true;
        }
        this.profiles[HeapProfileType][uid] = snapShot;
    }
    getProfile(id, params, clientId, agent) {
        let profile = this.profiles[params.type][params.uid];
        let self = this;
        if (!profile || !profile.finish) {
            let timerId = setInterval(function () {
                profile = self.profiles[params.type][params.uid];
                if (!!profile) {
                    clearInterval(timerId);
                    self.asyncGet(id, params, profile, clientId, agent);
                }
            }, 5000);
        }
        else {
            this.asyncGet(id, params, profile, clientId, agent);
        }
    }
    asyncGet(id, params, snapshot, clientId, agent) {
        let uid = params.uid;
        if (params.type === HeapProfileType) {
            for (let index in snapshot.data) {
                let chunk = snapshot.data[index];
                this.sendEvent({
                    method: "Profiler.addHeapSnapshotChunk",
                    params: { uid: uid, chunk: chunk }
                }, clientId, agent);
            }
            this.sendEvent({ method: "Profiler.finishHeapSnapshot", params: { uid: uid } }, clientId, agent);
            this.sendResult(id, {
                profile: {
                    title: snapshot.title,
                    uid: uid,
                    typeId: HeapProfileType
                }
            }, clientId, agent);
        }
        else if (params.type === CPUProfileType) {
            this.sendResult(id, {
                profile: {
                    title: snapshot.title,
                    uid: uid,
                    typeId: CPUProfileType,
                    head: snapshot.data.head,
                    bottomUpHead: snapshot.data.bottomUpHead
                }
            }, clientId, agent);
        }
    }
    clearProfiles(id, params) {
        this.profiles.HEAP = {};
        this.profiles.CPU = {};
        //profiler.deleteAllSnapshots();
        //profiler.deleteAllProfiles();
    }
    sendResult(id, res, clientId, agent) {
        agent.notifyClient(clientId, "profiler", JSON.stringify({ id: id, result: res }));
    }
    sendEvent(res, clientId, agent) {
        agent.notifyClient(clientId, "profiler", JSON.stringify(res));
    }
    start(id, params, clientId, agent) {
        let uid = params.uid;
        agent.notifyById(uid, "profiler", {
            type: "CPU",
            action: "start",
            uid: uid,
            clientId: clientId
        });
        this.sendEvent({
            method: "Profiler.setRecordingProfile",
            params: { isProfiling: true }
        }, clientId, agent);
        this.sendResult(id, {}, clientId, agent);
    }
    stop(id, params, clientId, agent) {
        let uid = params.uid;
        agent.notifyById(uid, "profiler", {
            type: "CPU",
            action: "stop",
            uid: uid,
            clientId: clientId
        });
        this.sendResult(id, {}, clientId, agent);
    }
    stopCallBack(res, clientId, agent) {
        let uid = res.msg.uid;
        let profiler = this.profiles[CPUProfileType][uid];
        if (!profiler || profiler.finish) {
            profiler = {
                data: null,
                finish: true,
                typeId: CPUProfileType,
                uid: uid,
                title: uid
            };
        }
        profiler.data = res;
        this.profiles[CPUProfileType][uid] = profiler;
        this.sendEvent({
            method: "Profiler.addProfileHeader",
            params: {
                header: {
                    title: profiler.title,
                    uid: uid,
                    typeId: CPUProfileType
                }
            }
        }, clientId, agent);
    }
}
exports.ProfileProxy = ProfileProxy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZVByb3h5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvZmlsZVByb3h5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDO0FBQy9CLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQztBQWE3QjtJQUdDO1FBQ0MsSUFBSSxDQUFDLFFBQVEsR0FBRztZQUNmLElBQUksRUFBRSxFQUFFO1lBQ1IsR0FBRyxFQUFFLEVBQUU7U0FDUCxDQUFDO1FBRUYsSUFBSSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUM7SUFDN0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxFQUFVLEVBQUUsTUFBVyxFQUFFLFFBQWdCLEVBQUUsS0FBVTtRQUMzRCxJQUFJLENBQUMsVUFBVSxDQUNkLEVBQUUsRUFDRjtZQUNDLE1BQU0sRUFBRSxJQUFJO1NBQ1osRUFDRCxRQUFRLEVBQ1IsS0FBSyxDQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQsbUJBQW1CLENBQUMsRUFBVSxFQUFFLE1BQVcsRUFBRSxRQUFnQixFQUFFLEtBQVU7UUFDeEUsSUFBSSxDQUFDLFVBQVUsQ0FDZCxFQUFFLEVBQ0Y7WUFDQyxNQUFNLEVBQUUsS0FBSztTQUNiLEVBQ0QsUUFBUSxFQUNSLEtBQUssQ0FDTCxDQUFDO0lBQ0gsQ0FBQztJQUVELFVBQVUsQ0FBQyxFQUFVLEVBQUUsTUFBVyxFQUFFLFFBQWdCLEVBQUUsS0FBVTtRQUMvRCxJQUFJLENBQUMsVUFBVSxDQUNkLEVBQUUsRUFDRjtZQUNDLE1BQU0sRUFBRSxJQUFJO1NBQ1osRUFDRCxRQUFRLEVBQ1IsS0FBSyxDQUNMLENBQUM7SUFDSCxDQUFDO0lBRUQsZUFBZSxDQUFDLEVBQVUsRUFBRSxNQUFXLEVBQUUsUUFBZ0IsRUFBRSxLQUFVO1FBQ3BFLElBQUksQ0FBQyxVQUFVLENBQ2QsRUFBRSxFQUNGO1lBQ0MsTUFBTSxFQUFFLElBQUk7U0FDWixFQUNELFFBQVEsRUFDUixLQUFLLENBQ0wsQ0FB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LFFBQVEsRUFDUixLQUFLLENBQ0wsQ0FBQztJQUNILENBQUM7Q0FDRDtBQS9RRCxvQ0ErUUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5cbmNvbnN0IEhlYXBQcm9maWxlVHlwZSA9IFwiSEVBUFwiO1xuY29uc3QgQ1BVUHJvZmlsZVR5cGUgPSBcIkNQVVwiO1xuXG5pbnRlcmZhY2UgUHJvZmlsZXIge1xuXHRkYXRhOiBhbnlbXTtcblx0ZmluaXNoOiBib29sZWFuO1xuXHR0eXBlSWQ/OiBzdHJpbmc7XG5cdHVpZDogc3RyaW5nO1xuXHR0aXRsZTogc3RyaW5nO1xufVxuXG50eXBlIFByb2ZpbGVyTWFwID0geyBbaWR4OiBzdHJpbmddOiBQcm9maWxlciB9O1xudHlwZSBQcm9maWxlcnMgPSB7IFtpZHg6IHN0cmluZ106IFByb2ZpbGVyTWFwIH07XG5cbmV4cG9ydCBjbGFzcyBQcm9maWxlUHJveHkge1xuXHRwcml2YXRlIGlzUHJvZmlsaW5nQ1BVOiBib29sZWFuO1xuXHRwcml2YXRlIHByb2ZpbGVzOiBQcm9maWxlcnM7XG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMucHJvZmlsZXMgPSB7XG5cdFx0XHRIRUFQOiB7fSxcblx0XHRcdENQVToge31cblx0XHR9O1xuXG5cdFx0dGhpcy5pc1Byb2ZpbGluZ0NQVSA9IGZhbHNlO1xuXHR9XG5cblx0ZW5hYmxlKGlkOiBzdHJpbmcsIHBhcmFtczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0dGhpcy5zZW5kUmVzdWx0KFxuXHRcdFx0aWQsXG5cdFx0XHR7XG5cdFx0XHRcdHJlc3VsdDogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdGNsaWVudElkLFxuXHRcdFx0YWdlbnRcblx0XHQpO1xuXHR9XG5cblx0Y2F1c2VzUmVjb21waWxhdGlvbihpZDogc3RyaW5nLCBwYXJhbXM6IGFueSwgY2xpZW50SWQ6IHN0cmluZywgYWdlbnQ6IGFueSkge1xuXHRcdHRoaXMuc2VuZFJlc3VsdChcblx0XHRcdGlkLFxuXHRcdFx0e1xuXHRcdFx0XHRyZXN1bHQ6IGZhbHNlXG5cdFx0XHR9LFxuXHRcdFx0Y2xpZW50SWQsXG5cdFx0XHRhZ2VudFxuXHRcdCk7XG5cdH1cblxuXHRpc1NhbXBsaW5nKGlkOiBzdHJpbmcsIHBhcmFtczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0dGhpcy5zZW5kUmVzdWx0KFxuXHRcdFx0aWQsXG5cdFx0XHR7XG5cdFx0XHRcdHJlc3VsdDogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdGNsaWVudElkLFxuXHRcdFx0YWdlbnRcblx0XHQpO1xuXHR9XG5cblx0aGFzSGVhcFByb2ZpbGVyKGlkOiBzdHJpbmcsIHBhcmFtczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0dGhpcy5zZW5kUmVzdWx0KFxuXHRcdFx0aWQsXG5cdFx0XHR7XG5cdFx0XHRcdHJlc3VsdDogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdGNsaWVudElkLFxuXHRcdFx0YWdlbnRcblx0XHQpO1xuXHR9XG5cblx0Z2V0UHJvZmlsZUhlYWRlcnMoaWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIGNsaWVudElkOiBzdHJpbmcsIGFnZW50OiBhbnkpIHtcblx0XHRsZXQgaGVhZGVycyA9IFtdO1xuXHRcdGZvciAobGV0IHR5cGUgaW4gdGhpcy5wcm9maWxlcykge1xuXHRcdFx0Zm9yIChsZXQgcHJvZmlsZUlkIGluIHRoaXMucHJvZmlsZXNbdHlwZV0pIHtcblx0XHRcdFx0bGV0IHByb2ZpbGUgPSB0aGlzLnByb2ZpbGVzW3R5cGVdW3Byb2ZpbGVJZF07XG5cdFx0XHRcdGhlYWRlcnMucHVzaCh7XG5cdFx0XHRcdFx0dGl0bGU6IHByb2ZpbGUudGl0bGUsXG5cdFx0XHRcdFx0dWlkOiBwcm9maWxlLnVpZCxcblx0XHRcdFx0XHR0eXBlSWQ6IHR5cGVcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHRoaXMuc2VuZFJlc3VsdChcblx0XHRcdGlkLFxuXHRcdFx0e1xuXHRcdFx0XHRoZWFkZXJzOiBoZWFkZXJzXG5cdFx0XHR9LFxuXHRcdFx0Y2xpZW50SWQsXG5cdFx0XHRhZ2VudFxuXHRcdCk7XG5cdH1cblxuXHR0YWtlSGVhcFNuYXBzaG90KGlkOiBzdHJpbmcsIHBhcmFtczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0bGV0IHVpZCA9IHBhcmFtcy51aWQ7XG5cblx0XHRhZ2VudC5ub3RpZnlCeUlkKHVpZCwgXCJwcm9maWxlclwiLCB7XG5cdFx0XHR0eXBlOiBcImhlYXBcIixcblx0XHRcdGFjdGlvbjogXCJzdGFydFwiLFxuXHRcdFx0dWlkOiB1aWQsXG5cdFx0XHRjbGllbnRJZDogY2xpZW50SWRcblx0XHR9KTtcblxuXHRcdHRoaXMuc2VuZEV2ZW50KFxuXHRcdFx0e1xuXHRcdFx0XHRtZXRob2Q6IFwiUHJvZmlsZXIuYWRkUHJvZmlsZUhlYWRlclwiLFxuXHRcdFx0XHRwYXJhbXM6IHtcblx0XHRcdFx0XHRoZWFkZXI6IHsgdGl0bGU6IHVpZCwgdWlkOiB1aWQsIHR5cGVJZDogSGVhcFByb2ZpbGVUeXBlIH1cblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdGNsaWVudElkLFxuXHRcdFx0YWdlbnRcblx0XHQpO1xuXHRcdHRoaXMuc2VuZFJlc3VsdChpZCwge30sIGNsaWVudElkLCBhZ2VudCk7XG5cdH1cblxuXHR0YWtlU25hcENhbGxCYWNrKGRhdGE6IGFueSkge1xuXHRcdGxldCB1aWQgPSBkYXRhLnBhcmFtcy51aWQgfHwgMDtcblx0XHRsZXQgc25hcFNob3QgPSB0aGlzLnByb2ZpbGVzW0hlYXBQcm9maWxlVHlwZV1bdWlkXTtcblx0XHRpZiAoIXNuYXBTaG90IHx8IHNuYXBTaG90LmZpbmlzaCkge1xuXHRcdFx0c25hcFNob3QgPSB7XG5cdFx0XHRcdGRhdGE6IFtdLFxuXHRcdFx0XHRmaW5pc2g6IGZhbHNlLFxuXHRcdFx0XHR1aWQ6IHVpZCxcblx0XHRcdFx0dGl0bGU6IHVpZFxuXHRcdFx0fTtcblx0XHR9XG5cdFx0aWYgKGRhdGEubWV0aG9kID09PSBcIlByb2ZpbGVyLmFkZEhlYXBTbmFwc2hvdENodW5rXCIpIHtcblx0XHRcdGxldCBjaHVuayA9IGRhdGEucGFyYW1zLmNodW5rO1xuXHRcdFx0c25hcFNob3QuZGF0YS5wdXNoKGNodW5rKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0c25hcFNob3QuZmluaXNoID0gdHJ1ZTtcblx0XHR9XG5cdFx0dGhpcy5wcm9maWxlc1tIZWFwUHJvZmlsZVR5cGVdW3VpZF0gPSBzbmFwU2hvdDtcblx0fVxuXG5cdGdldFByb2ZpbGUoaWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIGNsaWVudElkOiBzdHJpbmcsIGFnZW50OiBhbnkpIHtcblx0XHRsZXQgcHJvZmlsZSA9IHRoaXMucHJvZmlsZXNbcGFyYW1zLnR5cGVdW3BhcmFtcy51aWRdO1xuXHRcdGxldCBzZWxmID0gdGhpcztcblx0XHRpZiAoIXByb2ZpbGUgfHwgIXByb2ZpbGUuZmluaXNoKSB7XG5cdFx0XHRsZXQgdGltZXJJZCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRwcm9maWxlID0gc2VsZi5wcm9maWxlc1twYXJhbXMudHlwZV1bcGFyYW1zLnVpZF07XG5cdFx0XHRcdGlmICghIXByb2ZpbGUpIHtcblx0XHRcdFx0XHRjbGVhckludGVydmFsKHRpbWVySWQpO1xuXHRcdFx0XHRcdHNlbGYuYXN5bmNHZXQoaWQsIHBhcmFtcywgcHJvZmlsZSwgY2xpZW50SWQsIGFnZW50KTtcblx0XHRcdFx0fVxuXHRcdFx0fSwgNTAwMCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuYXN5bmNHZXQoaWQsIHBhcmFtcywgcHJvZmlsZSwgY2xpZW50SWQsIGFnZW50KTtcblx0XHR9XG5cdH1cblxuXHRhc3luY0dldChcblx0XHRpZDogc3RyaW5nLFxuXHRcdHBhcmFtczogYW55LFxuXHRcdHNuYXBzaG90OiBhbnksXG5cdFx0Y2xpZW50SWQ6IHN0cmluZyxcblx0XHRhZ2VudDogYW55XG5cdCkge1xuXHRcdGxldCB1aWQgPSBwYXJhbXMudWlkO1xuXHRcdGlmIChwYXJhbXMudHlwZSA9PT0gSGVhcFByb2ZpbGVUeXBlKSB7XG5cdFx0XHRmb3IgKGxldCBpbmRleCBpbiBzbmFwc2hvdC5kYXRhKSB7XG5cdFx0XHRcdGxldCBjaHVuayA9IHNuYXBzaG90LmRhdGFbaW5kZXhdO1xuXHRcdFx0XHR0aGlzLnNlbmRFdmVudChcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRtZXRob2Q6IFwiUHJvZmlsZXIuYWRkSGVhcFNuYXBzaG90Q2h1bmtcIixcblx0XHRcdFx0XHRcdHBhcmFtczogeyB1aWQ6IHVpZCwgY2h1bms6IGNodW5rIH1cblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdGNsaWVudElkLFxuXHRcdFx0XHRcdGFnZW50XG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLnNlbmRFdmVudChcblx0XHRcdFx0eyBtZXRob2Q6IFwiUHJvZmlsZXIuZmluaXNoSGVhcFNuYXBzaG90XCIsIHBhcmFtczogeyB1aWQ6IHVpZCB9IH0sXG5cdFx0XHRcdGNsaWVudElkLFxuXHRcdFx0XHRhZ2VudFxuXHRcdFx0KTtcblx0XHRcdHRoaXMuc2VuZFJlc3VsdChcblx0XHRcdFx0aWQsXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRwcm9maWxlOiB7XG5cdFx0XHRcdFx0XHR0aXRsZTogc25hcHNob3QudGl0bGUsXG5cdFx0XHRcdFx0XHR1aWQ6IHVpZCxcblx0XHRcdFx0XHRcdHR5cGVJZDogSGVhcFByb2ZpbGVUeXBlXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjbGllbnRJZCxcblx0XHRcdFx0YWdlbnRcblx0XHRcdCk7XG5cdFx0fSBlbHNlIGlmIChwYXJhbXMudHlwZSA9PT0gQ1BVUHJvZmlsZVR5cGUpIHtcblx0XHRcdHRoaXMuc2VuZFJlc3VsdChcblx0XHRcdFx0aWQsXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRwcm9maWxlOiB7XG5cdFx0XHRcdFx0XHR0aXRsZTogc25hcHNob3QudGl0bGUsXG5cdFx0XHRcdFx0XHR1aWQ6IHVpZCxcblx0XHRcdFx0XHRcdHR5cGVJZDogQ1BVUHJvZmlsZVR5cGUsXG5cdFx0XHRcdFx0XHRoZWFkOiBzbmFwc2hvdC5kYXRhLmhlYWQsXG5cdFx0XHRcdFx0XHRib3R0b21VcEhlYWQ6IHNuYXBzaG90LmRhdGEuYm90dG9tVXBIZWFkXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjbGllbnRJZCxcblx0XHRcdFx0YWdlbnRcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0Y2xlYXJQcm9maWxlcyhpZDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuXHRcdHRoaXMucHJvZmlsZXMuSEVBUCA9IHt9O1xuXHRcdHRoaXMucHJvZmlsZXMuQ1BVID0ge307XG5cdFx0Ly9wcm9maWxlci5kZWxldGVBbGxTbmFwc2hvdHMoKTtcblx0XHQvL3Byb2ZpbGVyLmRlbGV0ZUFsbFByb2ZpbGVzKCk7XG5cdH1cblxuXHRzZW5kUmVzdWx0KGlkOiBzdHJpbmcsIHJlczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0YWdlbnQubm90aWZ5Q2xpZW50KFxuXHRcdFx0Y2xpZW50SWQsXG5cdFx0XHRcInByb2ZpbGVyXCIsXG5cdFx0XHRKU09OLnN0cmluZ2lmeSh7IGlkOiBpZCwgcmVzdWx0OiByZXMgfSlcblx0XHQpO1xuXHR9XG5cblx0c2VuZEV2ZW50KHJlczogYW55LCBjbGllbnRJZDogc3RyaW5nLCBhZ2VudDogYW55KSB7XG5cdFx0YWdlbnQubm90aWZ5Q2xpZW50KGNsaWVudElkLCBcInByb2ZpbGVyXCIsIEpTT04uc3RyaW5naWZ5KHJlcykpO1xuXHR9XG5cblx0c3RhcnQoaWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIGNsaWVudElkOiBzdHJpbmcsIGFnZW50OiBhbnkpIHtcblx0XHRsZXQgdWlkID0gcGFyYW1zLnVpZDtcblxuXHRcdGFnZW50Lm5vdGlmeUJ5SWQodWlkLCBcInByb2ZpbGVyXCIsIHtcblx0XHRcdHR5cGU6IFwiQ1BVXCIsXG5cdFx0XHRhY3Rpb246IFwic3RhcnRcIixcblx0XHRcdHVpZDogdWlkLFxuXHRcdFx0Y2xpZW50SWQ6IGNsaWVudElkXG5cdFx0fSk7XG5cdFx0dGhpcy5zZW5kRXZlbnQoXG5cdFx0XHR7XG5cdFx0XHRcdG1ldGhvZDogXCJQcm9maWxlci5zZXRSZWNvcmRpbmdQcm9maWxlXCIsXG5cdFx0XHRcdHBhcmFtczogeyBpc1Byb2ZpbGluZzogdHJ1ZSB9XG5cdFx0XHR9LFxuXHRcdFx0Y2xpZW50SWQsXG5cdFx0XHRhZ2VudFxuXHRcdCk7XG5cdFx0dGhpcy5zZW5kUmVzdWx0KGlkLCB7fSwgY2xpZW50SWQsIGFnZW50KTtcblx0fVxuXG5cdHN0b3AoaWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIGNsaWVudElkOiBzdHJpbmcsIGFnZW50OiBhbnkpIHtcblx0XHRsZXQgdWlkID0gcGFyYW1zLnVpZDtcblx0XHRhZ2VudC5ub3RpZnlCeUlkKHVpZCwgXCJwcm9maWxlclwiLCB7XG5cdFx0XHR0eXBlOiBcIkNQVVwiLFxuXHRcdFx0YWN0aW9uOiBcInN0b3BcIixcblx0XHRcdHVpZDogdWlkLFxuXHRcdFx0Y2xpZW50SWQ6IGNsaWVudElkXG5cdFx0fSk7XG5cdFx0dGhpcy5zZW5kUmVzdWx0KGlkLCB7fSwgY2xpZW50SWQsIGFnZW50KTtcblx0fVxuXG5cdHN0b3BDYWxsQmFjayhyZXM6IGFueSwgY2xpZW50SWQ6IHN0cmluZywgYWdlbnQ6IGFueSkge1xuXHRcdGxldCB1aWQgPSByZXMubXNnLnVpZDtcblx0XHRsZXQgcHJvZmlsZXIgPSB0aGlzLnByb2ZpbGVzW0NQVVByb2ZpbGVUeXBlXVt1aWRdO1xuXHRcdGlmICghcHJvZmlsZXIgfHwgcHJvZmlsZXIuZmluaXNoKSB7XG5cdFx0XHRwcm9maWxlciA9IHtcblx0XHRcdFx0ZGF0YTogPGFueT5udWxsLFxuXHRcdFx0XHRmaW5pc2g6IHRydWUsXG5cdFx0XHRcdHR5cGVJZDogQ1BVUHJvZmlsZVR5cGUsXG5cdFx0XHRcdHVpZDogdWlkLFxuXHRcdFx0XHR0aXRsZTogdWlkXG5cdFx0XHR9O1xuXHRcdH1cblx0XHRwcm9maWxlci5kYXRhID0gcmVzO1xuXHRcdHRoaXMucHJvZmlsZXNbQ1BVUHJvZmlsZVR5cGVdW3VpZF0gPSBwcm9maWxlcjtcblx0XHR0aGlzLnNlbmRFdmVudChcblx0XHRcdHtcblx0XHRcdFx0bWV0aG9kOiBcIlByb2ZpbGVyLmFkZFByb2ZpbGVIZWFkZXJcIixcblx0XHRcdFx0cGFyYW1zOiB7XG5cdFx0XHRcdFx0aGVhZGVyOiB7XG5cdFx0XHRcdFx0XHR0aXRsZTogcHJvZmlsZXIudGl0bGUsXG5cdFx0XHRcdFx0XHR1aWQ6IHVpZCxcblx0XHRcdFx0XHRcdHR5cGVJZDogQ1BVUHJvZmlsZVR5cGVcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRjbGllbnRJZCxcblx0XHRcdGFnZW50XG5cdFx0KTtcblx0fVxufVxuIl19