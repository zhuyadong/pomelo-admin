"use strict";
/*!
 * Pomelo -- commandLine Client
 * Copyright(c) 2015 fantasyni <fantasyni@163.com>
 * MIT Licensed
 */
Object.defineProperty(exports, "__esModule", { value: true });
const protocol = require("../util/protocol");
const utils = require("../util/utils");
const mqttClient_1 = require("../protocol/mqtt/mqttClient");
class AdminClient {
    constructor(opt) {
        this.state = AdminClient.ST_INITED;
        this.id = "";
        this.reqId = 1;
        this.callbacks = {};
        this.listeners = {};
        this.state = AdminClient.ST_INITED;
        this.socket = null;
        opt = opt || {};
        this.username = opt["username"] || "";
        this.password = opt["password"] || "";
        this.md5 = opt["md5"] || false;
    }
    connect(id, host, port, cb) {
        this.id = id;
        console.log("try to connect " + host + ":" + port);
        this.socket = new mqttClient_1.MqttClient({
            id: id
        });
        this.socket.connect(host, port);
        // this.socket = io.connect('http://' + host + ':' + port, {
        // 	'force new connection': true,
        // 	'reconnect': false
        // });
        this.socket.on("connect", () => {
            this.state = AdminClient.ST_CONNECTED;
            if (this.md5) {
                this.password = utils.md5(this.password);
            }
            this.doSend("register", {
                type: "client",
                id: id,
                username: this.username,
                password: this.password,
                md5: this.md5
            });
        });
        this.socket.on("register", res => {
            if (res.code !== protocol.PRO_OK) {
                cb(res.msg);
                return;
            }
            this.state = AdminClient.ST_REGISTERED;
            cb();
        });
        this.socket.on("client", msg => {
            msg = protocol.parse(msg);
            if (msg.respId) {
                // response for request
                let cb = this.callbacks[msg.respId];
                delete this.callbacks[msg.respId];
                if (cb && typeof cb === "function") {
                    cb(msg.error, msg.body);
                }
            }
            else if (msg.moduleId) {
                // notify
                this.emit(msg.moduleId, msg);
            }
        });
        this.socket.on("error", err => {
            if (this.state < AdminClient.ST_CONNECTED) {
                cb(err);
            }
            this.emit("error", err);
        });
        this.socket.on("disconnect", reason => {
            this.state = AdminClient.ST_CLOSED;
            this.emit("close");
        });
    }
    request(moduleId, msg, cb) {
        let id = this.reqId++;
        // something dirty: attach current client id into msg
        msg = msg || {};
        msg.clientId = this.id;
        msg.username = this.username;
        let req = protocol.composeRequest(id, moduleId, msg);
        this.callbacks[id] = cb;
        this.doSend("client", req);
        // this.socket.emit('client', req);
    }
    notify(moduleId, msg) {
        // something dirty: attach current client id into msg
        msg = msg || {};
        msg.clientId = this.id;
        msg.username = this.username;
        let req = protocol.composeRequest(null, moduleId, msg);
        this.doSend("client", req);
        // this.socket.emit('client', req);
    }
    command(command, moduleId, msg, cb) {
        let id = this.reqId++;
        msg = msg || {};
        msg.clientId = this.id;
        msg.username = this.username;
        let commandReq = protocol.composeCommand(id, command, moduleId, msg);
        this.callbacks[id] = cb;
        this.doSend("client", commandReq);
        // this.socket.emit('client', commandReq);
    }
    doSend(topic, msg) {
        this.socket.send(topic, msg);
    }
    on(event, listener) {
        this.listeners[event] = this.listeners[event] || [];
        this.listeners[event].push(listener);
    }
    emit(event, ...other) {
        let listeners = this.listeners[event];
        if (!listeners || !listeners.length) {
            return;
        }
        let args = Array.prototype.slice.call(arguments, 1);
        let listener;
        for (let i = 0, l = listeners.length; i < l; i++) {
            listener = listeners[i];
            if (typeof listener === "function") {
                listener.apply(null, args);
            }
        }
    }
}
AdminClient.ST_INITED = 1;
AdminClient.ST_CONNECTED = 2;
AdminClient.ST_REGISTERED = 3;
AdminClient.ST_CLOSED = 4;
exports.AdminClient = AdminClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUVILDZDQUE4QztBQUM5Qyx1Q0FBd0M7QUFFeEMsNERBQXlEO0FBRXpEO0lBY0MsWUFBWSxHQUFRO1FBTFosVUFBSyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUM7UUFNckMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQztRQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFRLElBQUksQ0FBQztRQUN4QixHQUFHLEdBQUcsR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQztJQUNoQyxDQUFDO0lBRUQsT0FBTyxDQUFDLEVBQVUsRUFBRSxJQUFZLEVBQUUsSUFBWSxFQUFFLEVBQVk7UUFDM0QsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFFYixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHVCQUFVLENBQUM7WUFDNUIsRUFBRSxFQUFFLEVBQUU7U0FDTixDQUFDLENBQUM7UUFFSCxJ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QyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDcEQsSUFBSSxRQUFRLENBQUM7UUFDYixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2xELFFBQVEsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsRUFBRSxDQUFDLENBQUMsT0FBTyxRQUFRLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDcEMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDNUIsQ0FBQztRQUNGLENBQUM7SUFDRixDQUFDOztBQXRKZSxxQkFBUyxHQUFHLENBQUMsQ0FBQztBQUNkLHdCQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ2pCLHlCQUFhLEdBQUcsQ0FBQyxDQUFDO0FBQ2xCLHFCQUFTLEdBQUcsQ0FBQyxDQUFDO0FBSi9CLGtDQXdKQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogUG9tZWxvIC0tIGNvbW1hbmRMaW5lIENsaWVudFxuICogQ29weXJpZ2h0KGMpIDIwMTUgZmFudGFzeW5pIDxmYW50YXN5bmlAMTYzLmNvbT5cbiAqIE1JVCBMaWNlbnNlZFxuICovXG5cbmltcG9ydCBwcm90b2NvbCA9IHJlcXVpcmUoXCIuLi91dGlsL3Byb3RvY29sXCIpO1xuaW1wb3J0IHV0aWxzID0gcmVxdWlyZShcIi4uL3V0aWwvdXRpbHNcIik7XG5pbXBvcnQgeyB3YXRjaCB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgTXF0dENsaWVudCB9IGZyb20gXCIuLi9wcm90b2NvbC9tcXR0L21xdHRDbGllbnRcIjtcblxuZXhwb3J0IGNsYXNzIEFkbWluQ2xpZW50IHtcblx0c3RhdGljIHJlYWRvbmx5IFNUX0lOSVRFRCA9IDE7XG5cdHN0YXRpYyByZWFkb25seSBTVF9DT05ORUNURUQgPSAyO1xuXHRzdGF0aWMgcmVhZG9ubHkgU1RfUkVHSVNURVJFRCA9IDM7XG5cdHN0YXRpYyByZWFkb25seSBTVF9DTE9TRUQgPSA0O1xuXHRwcml2YXRlIGlkOiBzdHJpbmc7XG5cdHByaXZhdGUgcmVxSWQ6IG51bWJlcjtcblx0cHJpdmF0ZSBjYWxsYmFja3M6IHsgW2lkeDogc3RyaW5nXTogRnVuY3Rpb24gfTtcblx0cHJpdmF0ZSBsaXN0ZW5lcnM6IHsgW2lkeDogc3RyaW5nXTogRnVuY3Rpb25bXSB9O1xuXHRwcml2YXRlIHN0YXRlID0gQWRtaW5DbGllbnQuU1RfSU5JVEVEO1xuXHRwcml2YXRlIHNvY2tldDogTXF0dENsaWVudDtcblx0cHJpdmF0ZSB1c2VybmFtZTogc3RyaW5nO1xuXHRwcml2YXRlIHBhc3N3b3JkOiBzdHJpbmc7XG5cdHByaXZhdGUgbWQ1OiBib29sZWFuO1xuXHRjb25zdHJ1Y3RvcihvcHQ6IGFueSkge1xuXHRcdHRoaXMuaWQgPSBcIlwiO1xuXHRcdHRoaXMucmVxSWQgPSAxO1xuXHRcdHRoaXMuY2FsbGJhY2tzID0ge307XG5cdFx0dGhpcy5saXN0ZW5lcnMgPSB7fTtcblx0XHR0aGlzLnN0YXRlID0gQWRtaW5DbGllbnQuU1RfSU5JVEVEO1xuXHRcdHRoaXMuc29ja2V0ID0gPGFueT5udWxsO1xuXHRcdG9wdCA9IG9wdCB8fCB7fTtcblx0XHR0aGlzLnVzZXJuYW1lID0gb3B0W1widXNlcm5hbWVcIl0gfHwgXCJcIjtcblx0XHR0aGlzLnBhc3N3b3JkID0gb3B0W1wicGFzc3dvcmRcIl0gfHwgXCJcIjtcblx0XHR0aGlzLm1kNSA9IG9wdFtcIm1kNVwiXSB8fCBmYWxzZTtcblx0fVxuXG5cdGNvbm5lY3QoaWQ6IHN0cmluZywgaG9zdDogc3RyaW5nLCBwb3J0OiBudW1iZXIsIGNiOiBGdW5jdGlvbikge1xuXHRcdHRoaXMuaWQgPSBpZDtcblxuXHRcdGNvbnNvbGUubG9nKFwidHJ5IHRvIGNvbm5lY3QgXCIgKyBob3N0ICsgXCI6XCIgKyBwb3J0KTtcblx0XHR0aGlzLnNvY2tldCA9IG5ldyBNcXR0Q2xpZW50KHtcblx0XHRcdGlkOiBpZFxuXHRcdH0pO1xuXG5cdFx0dGhpcy5zb2NrZXQuY29ubmVjdChob3N0LCBwb3J0KTtcblxuXHRcdC8vIHRoaXMuc29ja2V0ID0gaW8uY29ubmVjdCgnaHR0cDovLycgKyBob3N0ICsgJzonICsgcG9ydCwge1xuXHRcdC8vIFx0J2ZvcmNlIG5ldyBjb25uZWN0aW9uJzogdHJ1ZSxcblx0XHQvLyBcdCdyZWNvbm5lY3QnOiBmYWxzZVxuXHRcdC8vIH0pO1xuXG5cdFx0dGhpcy5zb2NrZXQub24oXCJjb25uZWN0XCIsICgpID0+IHtcblx0XHRcdHRoaXMuc3RhdGUgPSBBZG1pbkNsaWVudC5TVF9DT05ORUNURUQ7XG5cdFx0XHRpZiAodGhpcy5tZDUpIHtcblx0XHRcdFx0dGhpcy5wYXNzd29yZCA9IHV0aWxzLm1kNSh0aGlzLnBhc3N3b3JkKTtcblx0XHRcdH1cblx0XHRcdHRoaXMuZG9TZW5kKFwicmVnaXN0ZXJcIiwge1xuXHRcdFx0XHR0eXBlOiBcImNsaWVudFwiLFxuXHRcdFx0XHRpZDogaWQsXG5cdFx0XHRcdHVzZXJuYW1lOiB0aGlzLnVzZXJuYW1lLFxuXHRcdFx0XHRwYXNzd29yZDogdGhpcy5wYXNzd29yZCxcblx0XHRcdFx0bWQ1OiB0aGlzLm1kNVxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNvY2tldC5vbihcInJlZ2lzdGVyXCIsIHJlcyA9PiB7XG5cdFx0XHRpZiAocmVzLmNvZGUgIT09IHByb3RvY29sLlBST19PSykge1xuXHRcdFx0XHRjYihyZXMubXNnKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLnN0YXRlID0gQWRtaW5DbGllbnQuU1RfUkVHSVNURVJFRDtcblx0XHRcdGNiKCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNvY2tldC5vbihcImNsaWVudFwiLCBtc2cgPT4ge1xuXHRcdFx0bXNnID0gcHJvdG9jb2wucGFyc2UobXNnKTtcblx0XHRcdGlmIChtc2cucmVzcElkKSB7XG5cdFx0XHRcdC8vIHJlc3BvbnNlIGZvciByZXF1ZXN0XG5cdFx0XHRcdGxldCBjYiA9IHRoaXMuY2FsbGJhY2tzW21zZy5yZXNwSWRdO1xuXHRcdFx0XHRkZWxldGUgdGhpcy5jYWxsYmFja3NbbXNnLnJlc3BJZF07XG5cdFx0XHRcdGlmIChjYiAmJiB0eXBlb2YgY2IgPT09IFwiZnVuY3Rpb25cIikge1xuXHRcdFx0XHRcdGNiKG1zZy5lcnJvciwgbXNnLmJvZHkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2UgaWYgKG1zZy5tb2R1bGVJZCkge1xuXHRcdFx0XHQvLyBub3RpZnlcblx0XHRcdFx0dGhpcy5lbWl0KG1zZy5tb2R1bGVJZCwgbXNnKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHRoaXMuc29ja2V0Lm9uKFwiZXJyb3JcIiwgZXJyID0+IHtcblx0XHRcdGlmICh0aGlzLnN0YXRlIDwgQWRtaW5DbGllbnQuU1RfQ09OTkVDVEVEKSB7XG5cdFx0XHRcdGNiKGVycik7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuZW1pdChcImVycm9yXCIsIGVycik7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNvY2tldC5vbihcImRpc2Nvbm5lY3RcIiwgcmVhc29uID0+IHtcblx0XHRcdHRoaXMuc3RhdGUgPSBBZG1pbkNsaWVudC5TVF9DTE9TRUQ7XG5cdFx0XHR0aGlzLmVtaXQoXCJjbG9zZVwiKTtcblx0XHR9KTtcblx0fVxuXG5cdHJlcXVlc3QobW9kdWxlSWQ6IHN0cmluZywgbXNnOiBhbnksIGNiOiBGdW5jdGlvbikge1xuXHRcdGxldCBpZCA9IHRoaXMucmVxSWQrKztcblx0XHQvLyBzb21ldGhpbmcgZGlydHk6IGF0dGFjaCBjdXJyZW50IGNsaWVudCBpZCBpbnRvIG1zZ1xuXHRcdG1zZyA9IG1zZyB8fCB7fTtcblx0XHRtc2cuY2xpZW50SWQgPSB0aGlzLmlkO1xuXHRcdG1zZy51c2VybmFtZSA9IHRoaXMudXNlcm5hbWU7XG5cdFx0bGV0IHJlcSA9IHByb3RvY29sLmNvbXBvc2VSZXF1ZXN0KGlkLCBtb2R1bGVJZCwgbXNnKTtcblx0XHR0aGlzLmNhbGxiYWNrc1tpZF0gPSBjYjtcblx0XHR0aGlzLmRvU2VuZChcImNsaWVudFwiLCByZXEpO1xuXHRcdC8vIHRoaXMuc29ja2V0LmVtaXQoJ2NsaWVudCcsIHJlcSk7XG5cdH1cblxuXHRub3RpZnkobW9kdWxlSWQ6IHN0cmluZywgbXNnOiBhbnkpIHtcblx0XHQvLyBzb21ldGhpbmcgZGlydHk6IGF0dGFjaCBjdXJyZW50IGNsaWVudCBpZCBpbnRvIG1zZ1xuXHRcdG1zZyA9IG1zZyB8fCB7fTtcblx0XHRtc2cuY2xpZW50SWQgPSB0aGlzLmlkO1xuXHRcdG1zZy51c2VybmFtZSA9IHRoaXMudXNlcm5hbWU7XG5cdFx0bGV0IHJlcSA9IHByb3RvY29sLmNvbXBvc2VSZXF1ZXN0KG51bGwhLCBtb2R1bGVJZCwgbXNnKTtcblx0XHR0aGlzLmRvU2VuZChcImNsaWVudFwiLCByZXEpO1xuXHRcdC8vIHRoaXMuc29ja2V0LmVtaXQoJ2NsaWVudCcsIHJlcSk7XG5cdH1cblxuXHRjb21tYW5kKGNvbW1hbmQ6IHN0cmluZywgbW9kdWxlSWQ6IHN0cmluZywgbXNnOiBhbnksIGNiOiBGdW5jdGlvbikge1xuXHRcdGxldCBpZCA9IHRoaXMucmVxSWQrKztcblx0XHRtc2cgPSBtc2cgfHwge307XG5cdFx0bXNnLmNsaWVudElkID0gdGhpcy5pZDtcblx0XHRtc2cudXNlcm5hbWUgPSB0aGlzLnVzZXJuYW1lO1xuXHRcdGxldCBjb21tYW5kUmVxID0gcHJvdG9jb2wuY29tcG9zZUNvbW1hbmQoaWQsIGNvbW1hbmQsIG1vZHVsZUlkLCBtc2cpO1xuXHRcdHRoaXMuY2FsbGJhY2tzW2lkXSA9IGNiO1xuXHRcdHRoaXMuZG9TZW5kKFwiY2xpZW50XCIsIGNvbW1hbmRSZXEpO1xuXHRcdC8vIHRoaXMuc29ja2V0LmVtaXQoJ2NsaWVudCcsIGNvbW1hbmRSZXEpO1xuXHR9XG5cblx0ZG9TZW5kKHRvcGljOiBzdHJpbmcsIG1zZzogYW55KSB7XG5cdFx0dGhpcy5zb2NrZXQuc2VuZCh0b3BpYywgbXNnKTtcblx0fVxuXG5cdG9uKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiBGdW5jdGlvbikge1xuXHRcdHRoaXMubGlzdGVuZXJzW2V2ZW50XSA9IHRoaXMubGlzdGVuZXJzW2V2ZW50XSB8fCBbXTtcblx0XHR0aGlzLmxpc3RlbmVyc1tldmVudF0ucHVzaChsaXN0ZW5lcik7XG5cdH1cblxuXHRlbWl0KGV2ZW50OiBzdHJpbmcsIC4uLm90aGVyOiBhbnlbXSkge1xuXHRcdGxldCBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVyc1tldmVudF07XG5cdFx0aWYgKCFsaXN0ZW5lcnMgfHwgIWxpc3RlbmVycy5sZW5ndGgpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRsZXQgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7XG5cdFx0bGV0IGxpc3RlbmVyO1xuXHRcdGZvciAobGV0IGkgPSAwLCBsID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuXHRcdFx0bGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07XG5cdFx0XHRpZiAodHlwZW9mIGxpc3RlbmVyID09PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRcdFx0bGlzdGVuZXIuYXBwbHkobnVsbCwgYXJncyk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG4iXX0=