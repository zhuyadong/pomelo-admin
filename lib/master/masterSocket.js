"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger = require("pomelo-logger").getLogger("pomelo-admin", "MasterSocket");
const Constants = require("../util/constants");
const protocol = require("../util/protocol");
class MasterSocket {
    constructor() {
        this.username = null;
        this.registered = false;
        this.id = null;
        this.type = null;
        this.info = null;
        this.agent = null;
        this.socket = null;
        this.username = null;
        this.registered = false;
    }
    onRegister(msg) {
        if (!msg || !msg.type) {
            return;
        }
        let serverId = msg.id;
        let serverType = msg.type;
        let socket = this.socket;
        if (serverType == Constants.TYPE_CLIENT) {
            // client connection not join the map
            this.id = serverId;
            this.type = serverType;
            this.info = "client";
            this.agent.doAuthUser(msg, socket, (err) => {
                if (err) {
                    return socket.disconnect();
                }
                this.username = msg.username;
                this.registered = true;
            });
            return;
        } // end of if(serverType === 'client')
        if (serverType == Constants.TYPE_MONITOR) {
            if (!serverId) {
                return;
            }
            // if is a normal server
            this.id = serverId;
            this.type = msg.serverType;
            this.info = msg.info;
            this.agent.doAuthServer(msg, socket, (err) => {
                if (err) {
                    return socket.disconnect();
                }
                this.registered = true;
            });
            this.repushQosMessage(serverId);
            return;
        } // end of if(serverType === 'monitor')
        this.agent.doSend(socket, "register", {
            code: protocol.PRO_FAIL,
            msg: "unknown auth master type"
        });
        socket.disconnect();
    }
    onMonitor(msg) {
        let socket = this.socket;
        if (!this.registered) {
            // not register yet, ignore any message
            // kick connections
            socket.disconnect();
            return;
        }
        let type = this.type;
        if (type === Constants.TYPE_CLIENT) {
            logger.error("invalid message from monitor, but current connect type is client.");
            return;
        }
        msg = protocol.parse(msg);
        let respId = msg.respId;
        if (respId) {
            // a response from monitor
            let cb = this.agent.callbacks[respId];
            if (!cb) {
                logger.warn("unknown resp id:" + respId);
                return;
            }
            let id = this.id;
            if (this.agent.msgMap[id]) {
                delete this.agent.msgMap[id][respId];
            }
            delete this.agent.callbacks[respId];
            return cb(msg.error, msg.body);
        }
        // a request or a notify from monitor
        this.agent.consoleService.execute(msg.moduleId, "masterHandler", msg.body, (err, res) => {
            if (protocol.isRequest(msg)) {
                let resp = protocol.composeResponse(msg, err, res);
                if (resp) {
                    this.agent.doSend(socket, "monitor", resp);
                }
            }
            else {
                //notify should not have a callback
                logger.warn("notify should not have a callback.");
            }
        });
    }
    onClient(msg) {
        let socket = this.socket;
        if (!this.registered) {
            // not register yet, ignore any message
            // kick connections
            return socket.disconnect();
        }
        let type = this.type;
        if (type !== Constants.TYPE_CLIENT) {
            logger.error("invalid message to client, but current connect type is " + type);
            return;
        }
        msg = protocol.parse(msg);
        let msgCommand = msg.command;
        let msgModuleId = msg.moduleId;
        let msgBody = msg.body;
        if (msgCommand) {
            // a command from client
            this.agent.consoleService.command(msgCommand, msgModuleId, msgBody, (err, res) => {
                if (protocol.isRequest(msg)) {
                    let resp = protocol.composeResponse(msg, err, res);
                    if (resp) {
                        this.agent.doSend(socket, "client", resp);
                    }
                }
                else {
                    //notify should not have a callback
                    logger.warn("notify should not have a callback.");
                }
            });
        }
        else {
            // a request or a notify from client
            // and client should not have any response to master for master would not request anything from client
            this.agent.consoleService.execute(msgModuleId, "clientHandler", msgBody, (err, res) => {
                if (protocol.isRequest(msg)) {
                    let resp = protocol.composeResponse(msg, err, res);
                    if (resp) {
                        this.agent.doSend(socket, "client", resp);
                    }
                }
                else {
                    //notify should not have a callback
                    logger.warn("notify should not have a callback.");
                }
            });
        }
    }
    onReconnect(msg, pid) {
        // reconnect a new connection
        if (!msg || !msg.type) {
            return;
        }
        let serverId = msg.id;
        if (!serverId) {
            return;
        }
        let socket = this.socket;
        // if is a normal server
        if (this.agent.idMap[serverId]) {
            // id has been registered
            this.agent.doSend(socket, "reconnect_ok", {
                code: protocol.PRO_FAIL,
                msg: "id has been registered. id:" + serverId
            });
            return;
        }
        let msgServerType = msg.serverType;
        let record = this.agent.addConnection(this.agent, serverId, msgServerType, msg.pid, msg.info, socket);
        this.id = serverId;
        this.type = msgServerType;
        this.registered = true;
        msg.info.pid = pid;
        this.info = msg.info;
        this.agent.doSend(socket, "reconnect_ok", {
            code: protocol.PRO_OK,
            msg: "ok"
        });
        this.agent.emit("reconnect", msg.info);
        this.repushQosMessage(serverId);
    }
    onDisconnect() {
        let socket = this.socket;
        if (socket) {
            delete this.agent.sockets[socket.id];
        }
        let registered = this.registered;
        if (!registered) {
            return;
        }
        let id = this.id;
        let type = this.type;
        let info = this.info;
        let username = this.username;
        logger.debug("disconnect %s %s %j", id, type, info);
        if (registered) {
            this.agent.removeConnection(this.agent, id, type, info);
            this.agent.emit("disconnect", id, type, info);
        }
        if (type === Constants.TYPE_CLIENT && registered) {
            logger.info("client user " + username + " exit");
        }
        this.registered = false;
        this.id = null;
        this.type = null;
    }
    repushQosMessage(serverId) {
        let socket = this.socket;
        // repush qos message
        let qosMsgs = this.agent.msgMap[serverId];
        if (!qosMsgs) {
            return;
        }
        logger.debug("repush qos message %j", qosMsgs);
        for (let reqId in qosMsgs) {
            let qosMsg = qosMsgs[reqId];
            let moduleId = qosMsg["moduleId"];
            let tmsg = qosMsg["msg"];
            this.agent.sendToMonitor(socket, reqId, moduleId, tmsg);
        }
    }
    onError(err) {
        // logger.error('server %s error %s', this.id, err.stack);
        // this.onDisconnect();
    }
}
exports.MasterSocket = MasterSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFzdGVyU29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFzdGVyU29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FDaEQsY0FBYyxFQUNkLGNBQWMsQ0FDZCxDQUFDO0FBQ0YsK0NBQWdEO0FBQ2hELDZDQUE4QztBQUc5QztJQVFDO1FBRlEsYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRTFCLElBQUksQ0FBQyxFQUFFLEdBQVEsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxJQUFJLEdBQVEsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxNQUFNLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxVQUFVLENBQUMsR0FBUTtRQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQztRQUNSLENBQUM7UUFFRCxJQUFJLFFBQVEsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3RCLElBQUksVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDMUIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUV6QixFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDekMscUNBQXFDO1lBQ3JDLElBQUksQ0FBQyxFQUFFLEdBQUcsUUFBUSxDQUFDO1lBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtnQkFDL0MsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDVCxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUM1QixDQUFDO2dCQUVELElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQztnQkFDN0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLENBQUM7UUFDUixDQUFDLENBQUMscUNBQXFDO1FBRXZDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsSUFBSSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUMxQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ2YsTUFBTSxDQUFDO1lBQ1IsQ0FBQztZQUVELHdCQUF3QjtZQUN4QixJQUFJLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQztZQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUM7WUFDM0IsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtnQkFDakQsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDVCxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUM1QixDQUFDO2dCQUVELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sQ0FBQztRQUNSLENBQUMsQ0FBQyxzQ0FBc0M7UUFFeEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRTtZQUNyQyxJQUFJLEVBQUUsUUFBUSxDQUFDLFFBQVE7WUFDdkIsR0FBRyxFQUFFLDBCQUEwQjtTQUMvQixDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVELFNBQVMsQ0FBQyxHQUFRO1FBQ2pCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDekIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUN0Qix1Q0FBdUM7WUFDdkMsbUJBQW1CO1lBQ25CLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNwQixNQUFNLENBQUM7UUFDUixDQUFDO1FBRUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FDWCxtRUFBbUUsQ0FDbkUsQ0FBQztZQUNGLE1BQU0sQ0FBQztRQUNSLENBQUM7UUFFRCxHQUFHLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQixJQUFJLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQ3hCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWiwwQkFBMEI7WUFDMUIsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNULE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLENBQUM7Z0JBQ3pDLE1BQU0sQ0FBQztZQUNSLENBQUM7WUFFRCxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ2pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN0QyxDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFFRCxxQ0FBcUM7UUFDckMsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUNoQyxHQUFHLENBQUMsUUFBUSxFQUNaLGVBQWUsRUFDZixHQUFHLENBQUMsSUFBSSxFQUNSLENBQUMsR0FBUSxFQUFFLEdBQVEsRUFBRSxFQUFFO1lBQ3RCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLElBQUksR0FBRyxRQUFRLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ25ELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDNUMsQ0FBQztZQUNGLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDUCxtQ0FBbUM7Z0JBQ25DLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0NBQW9DLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0YsQ0FBQyxDQUNELENBQUM7SUFDSCxDQUFDO0lBRUQsUUFBUSxDQUFDLEdBQVE7UUFDaEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN6QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLHVDQUF1QztZQUN2QyxtQkFBbUI7WUFDbkIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUM1QixDQUFDO1FBRUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FDWCx5REFBeUQsR0FBRyxJQUFJLENBQ2hFLENBQUM7WUFDRixNQUFNLENBQUM7UUFDUixDQUFDO1FBRUQsR0FBRyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFMUIsSUFBSSxVQUFVLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUM3QixJQUFJLFdBQVcsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQy9CLElBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFdkIsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNoQix3QkFBd0I7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUNoQyxVQUFVLEVBQ1YsV0FBVyxFQUNYLE9BQU8sRUFDUCxDQUFDLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtnQkFDdEIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdCLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDbkQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDVixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUMzQyxDQUFDO2dCQUNGLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ1AsbUNBQW1DO29CQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7Z0JBQ25ELENBQUM7WUFDRixDQUFDLENBQ0QsQ0FBQztRQUNILENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNQLG9DQUFvQztZQUNwQyxzR0FBc0c7WUFDdEcsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUNoQyxXQUFXLEVBQ1gsZUFBZSxFQUNmLE9BQU8sRUFDUCxDQUFDLEdBQVEsRUFBRSxHQUFRLEVBQUUsRUFBRTtnQkFDdEIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdCLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDbkQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzt3QkFDVixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUMzQyxDQUFDO2dCQUNGLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ1AsbUNBQW1DO29CQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7Z0JBQ25ELENBQUM7WUFDRixDQUFDLENBQ0QsQ0FBQztRQUNILENBQUM7SUFDRixDQUFDO0lBRUQsV0FBVyxDQUFDLEdBQVEsRUFBRSxHQUFZO1FBQ2pDLDZCQUE2QjtRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQztRQUNSLENBQUM7UUFFRCxJQUFJLFFBQVEsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNmLE1BQU0sQ0FBQztRQUNSLENBQUM7UUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBRXpCLHdCQUF3QjtRQUN4QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMseUJBQXlCO1lBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUU7Z0JBQ3pDLElBQUksRUFBRSxRQUFRLENBQUMsUUFBUTtnQkFDdkIsR0FBRyxFQUFFLDZCQUE2QixHQUFHLFFBQVE7YUFDN0MsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDO1FBQ1IsQ0FBQztRQUVELElBQUksYUFBYSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDbkMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQ3BDLElBQUksQ0FBQyxLQUFLLEVBQ1YsUUFBUSxFQUNSLGFBQWEsRUFDYixHQUFHLENBQUMsR0FBRyxFQUNQLEdBQUcsQ0FBQyxJQUFJLEVBQ1IsTUFBTSxDQUNOLENBQUM7UUFFRixJQUFJLENBQUMsRUFBRSxHQUFHLFFBQVEsQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUU7WUFDekMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxNQUFNO1lBQ3JCLEdBQUcsRUFBRSxJQUFJO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELFlBQVk7UUFDWCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUNqQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDakIsTUFBTSxDQUFDO1FBQ1IsQ0FBQztRQUVELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDakIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3JCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFFN0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDeEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsV0FBVyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEdBQUcsUUFBUSxHQUFHLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN4QixJQUFJLENBQUMsRUFBRSxHQUFRLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxHQUFRLElBQUksQ0FBQztJQUN2QixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsUUFBZ0I7UUFDaEMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN6QixxQkFBcUI7UUFDckIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFMUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ2QsTUFBTSxDQUFDO1FBQ1IsQ0FBQztRQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFL0MsR0FBRyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQztZQUMzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDNUIsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2xDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV6QixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6RCxDQUFDO0lBQ0YsQ0FBQztJQUVELE9BQU8sQ0FBQyxHQUFRO1FBQ2YsMERBQTBEO1FBQzFELHVCQUF1QjtJQUN4QixDQUFDO0NBQ0Q7QUFuU0Qsb0NBbVNDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFxuXHRcInBvbWVsby1hZG1pblwiLFxuXHRcIk1hc3RlclNvY2tldFwiXG4pO1xuaW1wb3J0IENvbnN0YW50cyA9IHJlcXVpcmUoXCIuLi91dGlsL2NvbnN0YW50c1wiKTtcbmltcG9ydCBwcm90b2NvbCA9IHJlcXVpcmUoXCIuLi91dGlsL3Byb3RvY29sXCIpO1xuaW1wb3J0IE1xdHRDb24gPSByZXF1aXJlKFwibXF0dC1jb25uZWN0aW9uXCIpO1xuXG5leHBvcnQgY2xhc3MgTWFzdGVyU29ja2V0IHtcblx0cHJpdmF0ZSBpZDogc3RyaW5nO1xuXHRwcml2YXRlIHR5cGU6IHN0cmluZztcblx0cHJpdmF0ZSBpbmZvOiBhbnk7XG5cdHByaXZhdGUgYWdlbnQ6IGFueTtcblx0cHJpdmF0ZSBzb2NrZXQ6IE1xdHRDb247XG5cdHByaXZhdGUgdXNlcm5hbWUgPSBudWxsO1xuXHRwcml2YXRlIHJlZ2lzdGVyZWQgPSBmYWxzZTtcblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5pZCA9IDxhbnk+bnVsbDtcblx0XHR0aGlzLnR5cGUgPSA8YW55Pm51bGw7XG5cdFx0dGhpcy5pbmZvID0gbnVsbDtcblx0XHR0aGlzLmFnZW50ID0gbnVsbDtcblx0XHR0aGlzLnNvY2tldCA9IDxhbnk+bnVsbDtcblx0XHR0aGlzLnVzZXJuYW1lID0gbnVsbDtcblx0XHR0aGlzLnJlZ2lzdGVyZWQgPSBmYWxzZTtcblx0fVxuXG5cdG9uUmVnaXN0ZXIobXNnOiBhbnkpIHtcblx0XHRpZiAoIW1zZyB8fCAhbXNnLnR5cGUpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRsZXQgc2VydmVySWQgPSBtc2cuaWQ7XG5cdFx0bGV0IHNlcnZlclR5cGUgPSBtc2cudHlwZTtcblx0XHRsZXQgc29ja2V0ID0gdGhpcy5zb2NrZXQ7XG5cblx0XHRpZiAoc2VydmVyVHlwZSA9PSBDb25zdGFudHMuVFlQRV9DTElFTlQpIHtcblx0XHRcdC8vIGNsaWVudCBjb25uZWN0aW9uIG5vdCBqb2luIHRoZSBtYXBcblx0XHRcdHRoaXMuaWQgPSBzZXJ2ZXJJZDtcblx0XHRcdHRoaXMudHlwZSA9IHNlcnZlclR5cGU7XG5cdFx0XHR0aGlzLmluZm8gPSBcImNsaWVudFwiO1xuXHRcdFx0dGhpcy5hZ2VudC5kb0F1dGhVc2VyKG1zZywgc29ja2V0LCAoZXJyOiBhbnkpID0+IHtcblx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdHJldHVybiBzb2NrZXQuZGlzY29ubmVjdCgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0dGhpcy51c2VybmFtZSA9IG1zZy51c2VybmFtZTtcblx0XHRcdFx0dGhpcy5yZWdpc3RlcmVkID0gdHJ1ZTtcblx0XHRcdH0pO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH0gLy8gZW5kIG9mIGlmKHNlcnZlclR5cGUgPT09ICdjbGllbnQnKVxuXG5cdFx0aWYgKHNlcnZlclR5cGUgPT0gQ29uc3RhbnRzLlRZUEVfTU9OSVRPUikge1xuXHRcdFx0aWYgKCFzZXJ2ZXJJZCkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdC8vIGlmIGlzIGEgbm9ybWFsIHNlcnZlclxuXHRcdFx0dGhpcy5pZCA9IHNlcnZlcklkO1xuXHRcdFx0dGhpcy50eXBlID0gbXNnLnNlcnZlclR5cGU7XG5cdFx0XHR0aGlzLmluZm8gPSBtc2cuaW5mbztcblx0XHRcdHRoaXMuYWdlbnQuZG9BdXRoU2VydmVyKG1zZywgc29ja2V0LCAoZXJyOiBhbnkpID0+IHtcblx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdHJldHVybiBzb2NrZXQuZGlzY29ubmVjdCgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0dGhpcy5yZWdpc3RlcmVkID0gdHJ1ZTtcblx0XHRcdH0pO1xuXG5cdFx0XHR0aGlzLnJlcHVzaFFvc01lc3NhZ2Uoc2VydmVySWQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH0gLy8gZW5kIG9mIGlmKHNlcnZlclR5cGUgPT09ICdtb25pdG9yJylcblxuXHRcdHRoaXMuYWdlbnQuZG9TZW5kKHNvY2tldCwgXCJyZWdpc3RlclwiLCB7XG5cdFx0XHRjb2RlOiBwcm90b2NvbC5QUk9fRkFJTCxcblx0XHRcdG1zZzogXCJ1bmtub3duIGF1dGggbWFzdGVyIHR5cGVcIlxuXHRcdH0pO1xuXG5cdFx0c29ja2V0LmRpc2Nvbm5lY3QoKTtcblx0fVxuXG5cdG9uTW9uaXRvcihtc2c6IGFueSkge1xuXHRcdGxldCBzb2NrZXQgPSB0aGlzLnNvY2tldDtcblx0XHRpZiAoIXRoaXMucmVnaXN0ZXJlZCkge1xuXHRcdFx0Ly8gbm90IHJlZ2lzdGVyIHlldCwgaWdub3JlIGFueSBtZXNzYWdlXG5cdFx0XHQvLyBraWNrIGNvbm5lY3Rpb25zXG5cdFx0XHRzb2NrZXQuZGlzY29ubmVjdCgpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCB0eXBlID0gdGhpcy50eXBlO1xuXHRcdGlmICh0eXBlID09PSBDb25zdGFudHMuVFlQRV9DTElFTlQpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XCJpbnZhbGlkIG1lc3NhZ2UgZnJvbSBtb25pdG9yLCBidXQgY3VycmVudCBjb25uZWN0IHR5cGUgaXMgY2xpZW50LlwiXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdG1zZyA9IHByb3RvY29sLnBhcnNlKG1zZyk7XG5cdFx0bGV0IHJlc3BJZCA9IG1zZy5yZXNwSWQ7XG5cdFx0aWYgKHJlc3BJZCkge1xuXHRcdFx0Ly8gYSByZXNwb25zZSBmcm9tIG1vbml0b3Jcblx0XHRcdGxldCBjYiA9IHRoaXMuYWdlbnQuY2FsbGJhY2tzW3Jlc3BJZF07XG5cdFx0XHRpZiAoIWNiKSB7XG5cdFx0XHRcdGxvZ2dlci53YXJuKFwidW5rbm93biByZXNwIGlkOlwiICsgcmVzcElkKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgaWQgPSB0aGlzLmlkO1xuXHRcdFx0aWYgKHRoaXMuYWdlbnQubXNnTWFwW2lkXSkge1xuXHRcdFx0XHRkZWxldGUgdGhpcy5hZ2VudC5tc2dNYXBbaWRdW3Jlc3BJZF07XG5cdFx0XHR9XG5cdFx0XHRkZWxldGUgdGhpcy5hZ2VudC5jYWxsYmFja3NbcmVzcElkXTtcblx0XHRcdHJldHVybiBjYihtc2cuZXJyb3IsIG1zZy5ib2R5KTtcblx0XHR9XG5cblx0XHQvLyBhIHJlcXVlc3Qgb3IgYSBub3RpZnkgZnJvbSBtb25pdG9yXG5cdFx0dGhpcy5hZ2VudC5jb25zb2xlU2VydmljZS5leGVjdXRlKFxuXHRcdFx0bXNnLm1vZHVsZUlkLFxuXHRcdFx0XCJtYXN0ZXJIYW5kbGVyXCIsXG5cdFx0XHRtc2cuYm9keSxcblx0XHRcdChlcnI6IGFueSwgcmVzOiBhbnkpID0+IHtcblx0XHRcdFx0aWYgKHByb3RvY29sLmlzUmVxdWVzdChtc2cpKSB7XG5cdFx0XHRcdFx0bGV0IHJlc3AgPSBwcm90b2NvbC5jb21wb3NlUmVzcG9uc2UobXNnLCBlcnIsIHJlcyk7XG5cdFx0XHRcdFx0aWYgKHJlc3ApIHtcblx0XHRcdFx0XHRcdHRoaXMuYWdlbnQuZG9TZW5kKHNvY2tldCwgXCJtb25pdG9yXCIsIHJlc3ApO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQvL25vdGlmeSBzaG91bGQgbm90IGhhdmUgYSBjYWxsYmFja1xuXHRcdFx0XHRcdGxvZ2dlci53YXJuKFwibm90aWZ5IHNob3VsZCBub3QgaGF2ZSBhIGNhbGxiYWNrLlwiKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdCk7XG5cdH1cblxuXHRvbkNsaWVudChtc2c6IGFueSkge1xuXHRcdGxldCBzb2NrZXQgPSB0aGlzLnNvY2tldDtcblx0XHRpZiAoIXRoaXMucmVnaXN0ZXJlZCkge1xuXHRcdFx0Ly8gbm90IHJlZ2lzdGVyIHlldCwgaWdub3JlIGFueSBtZXNzYWdlXG5cdFx0XHQvLyBraWNrIGNvbm5lY3Rpb25zXG5cdFx0XHRyZXR1cm4gc29ja2V0LmRpc2Nvbm5lY3QoKTtcblx0XHR9XG5cblx0XHRsZXQgdHlwZSA9IHRoaXMudHlwZTtcblx0XHRpZiAodHlwZSAhPT0gQ29uc3RhbnRzLlRZUEVfQ0xJRU5UKSB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFwiaW52YWxpZCBtZXNzYWdlIHRvIGNsaWVudCwgYnV0IGN1cnJlbnQgY29ubmVjdCB0eXBlIGlzIFwiICsgdHlwZVxuXHRcdFx0KTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRtc2cgPSBwcm90b2NvbC5wYXJzZShtc2cpO1xuXG5cdFx0bGV0IG1zZ0NvbW1hbmQgPSBtc2cuY29tbWFuZDtcblx0XHRsZXQgbXNnTW9kdWxlSWQgPSBtc2cubW9kdWxlSWQ7XG5cdFx0bGV0IG1zZ0JvZHkgPSBtc2cuYm9keTtcblxuXHRcdGlmIChtc2dDb21tYW5kKSB7XG5cdFx0XHQvLyBhIGNvbW1hbmQgZnJvbSBjbGllbnRcblx0XHRcdHRoaXMuYWdlbnQuY29uc29sZVNlcnZpY2UuY29tbWFuZChcblx0XHRcdFx0bXNnQ29tbWFuZCxcblx0XHRcdFx0bXNnTW9kdWxlSWQsXG5cdFx0XHRcdG1zZ0JvZHksXG5cdFx0XHRcdChlcnI6IGFueSwgcmVzOiBhbnkpID0+IHtcblx0XHRcdFx0XHRpZiAocHJvdG9jb2wuaXNSZXF1ZXN0KG1zZykpIHtcblx0XHRcdFx0XHRcdGxldCByZXNwID0gcHJvdG9jb2wuY29tcG9zZVJlc3BvbnNlKG1zZywgZXJyLCByZXMpO1xuXHRcdFx0XHRcdFx0aWYgKHJlc3ApIHtcblx0XHRcdFx0XHRcdFx0dGhpcy5hZ2VudC5kb1NlbmQoc29ja2V0LCBcImNsaWVudFwiLCByZXNwKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Ly9ub3RpZnkgc2hvdWxkIG5vdCBoYXZlIGEgY2FsbGJhY2tcblx0XHRcdFx0XHRcdGxvZ2dlci53YXJuKFwibm90aWZ5IHNob3VsZCBub3QgaGF2ZSBhIGNhbGxiYWNrLlwiKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdC8vIGEgcmVxdWVzdCBvciBhIG5vdGlmeSBmcm9tIGNsaWVudFxuXHRcdFx0Ly8gYW5kIGNsaWVudCBzaG91bGQgbm90IGhhdmUgYW55IHJlc3BvbnNlIHRvIG1hc3RlciBmb3IgbWFzdGVyIHdvdWxkIG5vdCByZXF1ZXN0IGFueXRoaW5nIGZyb20gY2xpZW50XG5cdFx0XHR0aGlzLmFnZW50LmNvbnNvbGVTZXJ2aWNlLmV4ZWN1dGUoXG5cdFx0XHRcdG1zZ01vZHVsZUlkLFxuXHRcdFx0XHRcImNsaWVudEhhbmRsZXJcIixcblx0XHRcdFx0bXNnQm9keSxcblx0XHRcdFx0KGVycjogYW55LCByZXM6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGlmIChwcm90b2NvbC5pc1JlcXVlc3QobXNnKSkge1xuXHRcdFx0XHRcdFx0bGV0IHJlc3AgPSBwcm90b2NvbC5jb21wb3NlUmVzcG9uc2UobXNnLCBlcnIsIHJlcyk7XG5cdFx0XHRcdFx0XHRpZiAocmVzcCkge1xuXHRcdFx0XHRcdFx0XHR0aGlzLmFnZW50LmRvU2VuZChzb2NrZXQsIFwiY2xpZW50XCIsIHJlc3ApO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHQvL25vdGlmeSBzaG91bGQgbm90IGhhdmUgYSBjYWxsYmFja1xuXHRcdFx0XHRcdFx0bG9nZ2VyLndhcm4oXCJub3RpZnkgc2hvdWxkIG5vdCBoYXZlIGEgY2FsbGJhY2suXCIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0KTtcblx0XHR9XG5cdH1cblxuXHRvblJlY29ubmVjdChtc2c6IGFueSwgcGlkPzogbnVtYmVyKSB7XG5cdFx0Ly8gcmVjb25uZWN0IGEgbmV3IGNvbm5lY3Rpb25cblx0XHRpZiAoIW1zZyB8fCAhbXNnLnR5cGUpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRsZXQgc2VydmVySWQgPSBtc2cuaWQ7XG5cdFx0aWYgKCFzZXJ2ZXJJZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCBzb2NrZXQgPSB0aGlzLnNvY2tldDtcblxuXHRcdC8vIGlmIGlzIGEgbm9ybWFsIHNlcnZlclxuXHRcdGlmICh0aGlzLmFnZW50LmlkTWFwW3NlcnZlcklkXSkge1xuXHRcdFx0Ly8gaWQgaGFzIGJlZW4gcmVnaXN0ZXJlZFxuXHRcdFx0dGhpcy5hZ2VudC5kb1NlbmQoc29ja2V0LCBcInJlY29ubmVjdF9va1wiLCB7XG5cdFx0XHRcdGNvZGU6IHByb3RvY29sLlBST19GQUlMLFxuXHRcdFx0XHRtc2c6IFwiaWQgaGFzIGJlZW4gcmVnaXN0ZXJlZC4gaWQ6XCIgKyBzZXJ2ZXJJZFxuXHRcdFx0fSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0bGV0IG1zZ1NlcnZlclR5cGUgPSBtc2cuc2VydmVyVHlwZTtcblx0XHRsZXQgcmVjb3JkID0gdGhpcy5hZ2VudC5hZGRDb25uZWN0aW9uKFxuXHRcdFx0dGhpcy5hZ2VudCxcblx0XHRcdHNlcnZlcklkLFxuXHRcdFx0bXNnU2VydmVyVHlwZSxcblx0XHRcdG1zZy5waWQsXG5cdFx0XHRtc2cuaW5mbyxcblx0XHRcdHNvY2tldFxuXHRcdCk7XG5cblx0XHR0aGlzLmlkID0gc2VydmVySWQ7XG5cdFx0dGhpcy50eXBlID0gbXNnU2VydmVyVHlwZTtcblx0XHR0aGlzLnJlZ2lzdGVyZWQgPSB0cnVlO1xuXHRcdG1zZy5pbmZvLnBpZCA9IHBpZDtcblx0XHR0aGlzLmluZm8gPSBtc2cuaW5mbztcblx0XHR0aGlzLmFnZW50LmRvU2VuZChzb2NrZXQsIFwicmVjb25uZWN0X29rXCIsIHtcblx0XHRcdGNvZGU6IHByb3RvY29sLlBST19PSyxcblx0XHRcdG1zZzogXCJva1wiXG5cdFx0fSk7XG5cblx0XHR0aGlzLmFnZW50LmVtaXQoXCJyZWNvbm5lY3RcIiwgbXNnLmluZm8pO1xuXG5cdFx0dGhpcy5yZXB1c2hRb3NNZXNzYWdlKHNlcnZlcklkKTtcblx0fVxuXG5cdG9uRGlzY29ubmVjdCgpIHtcblx0XHRsZXQgc29ja2V0ID0gdGhpcy5zb2NrZXQ7XG5cdFx0aWYgKHNvY2tldCkge1xuXHRcdFx0ZGVsZXRlIHRoaXMuYWdlbnQuc29ja2V0c1tzb2NrZXQuaWRdO1xuXHRcdH1cblxuXHRcdGxldCByZWdpc3RlcmVkID0gdGhpcy5yZWdpc3RlcmVkO1xuXHRcdGlmICghcmVnaXN0ZXJlZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCBpZCA9IHRoaXMuaWQ7XG5cdFx0bGV0IHR5cGUgPSB0aGlzLnR5cGU7XG5cdFx0bGV0IGluZm8gPSB0aGlzLmluZm87XG5cdFx0bGV0IHVzZXJuYW1lID0gdGhpcy51c2VybmFtZTtcblxuXHRcdGxvZ2dlci5kZWJ1ZyhcImRpc2Nvbm5lY3QgJXMgJXMgJWpcIiwgaWQsIHR5cGUsIGluZm8pO1xuXHRcdGlmIChyZWdpc3RlcmVkKSB7XG5cdFx0XHR0aGlzLmFnZW50LnJlbW92ZUNvbm5lY3Rpb24odGhpcy5hZ2VudCwgaWQsIHR5cGUsIGluZm8pO1xuXHRcdFx0dGhpcy5hZ2VudC5lbWl0KFwiZGlzY29ubmVjdFwiLCBpZCwgdHlwZSwgaW5mbyk7XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09IENvbnN0YW50cy5UWVBFX0NMSUVOVCAmJiByZWdpc3RlcmVkKSB7XG5cdFx0XHRsb2dnZXIuaW5mbyhcImNsaWVudCB1c2VyIFwiICsgdXNlcm5hbWUgKyBcIiBleGl0XCIpO1xuXHRcdH1cblxuXHRcdHRoaXMucmVnaXN0ZXJlZCA9IGZhbHNlO1xuXHRcdHRoaXMuaWQgPSA8YW55Pm51bGw7XG5cdFx0dGhpcy50eXBlID0gPGFueT5udWxsO1xuXHR9XG5cblx0cmVwdXNoUW9zTWVzc2FnZShzZXJ2ZXJJZDogc3RyaW5nKSB7XG5cdFx0bGV0IHNvY2tldCA9IHRoaXMuc29ja2V0O1xuXHRcdC8vIHJlcHVzaCBxb3MgbWVzc2FnZVxuXHRcdGxldCBxb3NNc2dzID0gdGhpcy5hZ2VudC5tc2dNYXBbc2VydmVySWRdO1xuXG5cdFx0aWYgKCFxb3NNc2dzKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0bG9nZ2VyLmRlYnVnKFwicmVwdXNoIHFvcyBtZXNzYWdlICVqXCIsIHFvc01zZ3MpO1xuXG5cdFx0Zm9yIChsZXQgcmVxSWQgaW4gcW9zTXNncykge1xuXHRcdFx0bGV0IHFvc01zZyA9IHFvc01zZ3NbcmVxSWRdO1xuXHRcdFx0bGV0IG1vZHVsZUlkID0gcW9zTXNnW1wibW9kdWxlSWRcIl07XG5cdFx0XHRsZXQgdG1zZyA9IHFvc01zZ1tcIm1zZ1wiXTtcblxuXHRcdFx0dGhpcy5hZ2VudC5zZW5kVG9Nb25pdG9yKHNvY2tldCwgcmVxSWQsIG1vZHVsZUlkLCB0bXNnKTtcblx0XHR9XG5cdH1cblxuXHRvbkVycm9yKGVycjogYW55KSB7XG5cdFx0Ly8gbG9nZ2VyLmVycm9yKCdzZXJ2ZXIgJXMgZXJyb3IgJXMnLCB0aGlzLmlkLCBlcnIuc3RhY2spO1xuXHRcdC8vIHRoaXMub25EaXNjb25uZWN0KCk7XG5cdH1cbn1cbiJdfQ==