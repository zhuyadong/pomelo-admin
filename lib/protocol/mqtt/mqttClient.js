"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger = require("pomelo-logger").getLogger("pomelo-admin", "MqttClient");
const constants = require("../../util/constants");
const MqttCon = require("mqtt-connection");
const net = require("net");
const events_1 = require("events");
class MqttClient extends events_1.EventEmitter {
    constructor(opts) {
        super();
        this.reconnectDelay = 0;
        this.clientId = "MQTT_ADMIN_" + Date.now();
        this.id = opts.id;
        this.requests = {};
        this.connectedTimes = 1;
        this.host = null;
        this.port = null;
        this.socket = null;
        this.lastPing = -1;
        this.lastPong = -1;
        this.closed = false;
        this.timeoutId = null;
        this.connected = false;
        this.reconnectId = null;
        this.timeoutFlag = false;
        this.keepaliveTimer = null;
        this.reconnectDelay = 0;
        this.reconnectDelayMax =
            opts.reconnectDelayMax ||
                constants.DEFAULT_PARAM.RECONNECT_DELAY_MAX;
        this.timeout = opts.timeout || constants.DEFAULT_PARAM.TIMEOUT;
        this.keepalive = opts.keepalive || constants.DEFAULT_PARAM.KEEPALIVE;
    }
    connect(host, port, cb) {
        cb = cb || function () { };
        if (this.connected) {
            return cb(new Error("MqttClient has already connected."));
        }
        if (host) {
            this.host = host;
        }
        else {
            host = this.host;
        }
        if (port) {
            this.port = port;
        }
        else {
            port = this.port;
        }
        this.closed = false;
        let stream = net.createConnection(this.port, this.host);
        this.socket = new MqttCon(stream);
        // logger.info('try to connect %s %s', this.host, this.port);
        this.socket.connect({
            clientId: this.clientId
        });
        this.addTimeout();
        this.socket.on("connack", () => {
            if (this.connected) {
                return;
            }
            this.connected = true;
            this.setupKeepAlive();
            if (this.connectedTimes++ == 1) {
                this.emit("connect");
                cb();
            }
            else {
                this.emit("reconnect");
            }
        });
        this.socket.on("publish", pkg => {
            let topic = pkg.topic;
            let msg = pkg.payload.toString();
            msg = JSON.parse(msg);
            // logger.debug('[MqttClient] publish %s %j', topic, msg);
            this.emit(topic, msg);
        });
        this.socket.on("close", () => {
            logger.error("mqtt socket is close, remote server host: %s, port: %s", host, port);
            this.onSocketClose();
        });
        this.socket.on("error", err => {
            logger.error("mqtt socket is error, remote server host: %s, port: %s", host, port);
            // this.emit('error', new Error('[MqttClient] socket is error, remote server ' + host + ':' + port));
            this.onSocketClose();
        });
        this.socket.on("pingresp", () => {
            this.lastPong = Date.now();
        });
        this.socket.on("disconnect", () => {
            logger.error("mqtt socket is disconnect, remote server host: %s, port: %s", host, port);
            this.emit("disconnect", this.id);
            this.onSocketClose();
        });
        this.socket.on("timeout", reconnectFlag => {
            if (reconnectFlag) {
                this.reconnect();
            }
            else {
                this.exit();
            }
        });
    }
    send(topic, msg) {
        // console.log('MqttClient send %s %j ~~~', topic, msg);
        this.socket.publish({
            topic: topic,
            payload: JSON.stringify(msg)
        });
    }
    onSocketClose() {
        // console.log('onSocketClose ' + this.closed);
        if (this.closed) {
            return;
        }
        clearInterval(this.keepaliveTimer);
        clearTimeout(this.timeoutId);
        this.keepaliveTimer = null;
        this.lastPing = -1;
        this.lastPong = -1;
        this.connected = false;
        this.closed = true;
        delete this.socket;
        this.socket = null;
        if (this.connectedTimes > 1) {
            this.reconnect();
        }
        else {
            this.exit();
        }
    }
    addTimeout(reconnectFlag) {
        if (this.timeoutFlag) {
            return;
        }
        this.timeoutFlag = true;
        this.timeoutId = setTimeout(() => {
            this.timeoutFlag = false;
            logger.error("mqtt client connect %s:%d timeout %d s", this.host, this.port, this.timeout / 1000);
            this.socket.emit("timeout", reconnectFlag);
        }, this.timeout);
    }
    reconnect() {
        let delay = this.reconnectDelay * 2 || constants.DEFAULT_PARAM.RECONNECT_DELAY;
        if (delay > this.reconnectDelayMax) {
            delay = this.reconnectDelayMax;
        }
        this.reconnectDelay = delay;
        // logger.debug('[MqttClient] reconnect %d ...', delay);
        this.reconnectId = setTimeout(() => {
            logger.info("reconnect delay %d s", delay / 1000);
            this.addTimeout(true);
            this.connect();
        }, delay);
    }
    setupKeepAlive() {
        clearTimeout(this.reconnectId);
        clearTimeout(this.timeoutId);
        this.keepaliveTimer = setInterval(() => {
            this.checkKeepAlive();
        }, this.keepalive);
    }
    checkKeepAlive() {
        if (this.closed) {
            return;
        }
        let now = Date.now();
        let KEEP_ALIVE_TIMEOUT = this.keepalive * 2;
        if (this.lastPing > 0) {
            if (this.lastPong < this.lastPing) {
                if (now - this.lastPing > KEEP_ALIVE_TIMEOUT) {
                    logger.error("mqtt rpc client checkKeepAlive error timeout for %d", KEEP_ALIVE_TIMEOUT);
                    this.close();
                }
            }
            else {
                this.socket.pingreq();
                this.lastPing = Date.now();
            }
        }
        else {
            this.socket.pingreq();
            this.lastPing = Date.now();
        }
    }
    disconnect() {
        this.close();
    }
    close() {
        this.connected = false;
        this.closed = true;
        this.socket.disconnect();
    }
    exit() {
        logger.info("exit ...");
        process.exit(0);
    }
}
exports.MqttClient = MqttClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXF0dENsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1xdHRDbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNoRixrREFBbUQ7QUFDbkQsMkNBQTRDO0FBRTVDLDJCQUE0QjtBQUM1QixtQ0FBc0M7QUFFdEMsZ0JBQXdCLFNBQVEscUJBQVk7SUFvQjNDLFlBQVksSUFBUztRQUNwQixLQUFLLEVBQUUsQ0FBQztRQUxELG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBTTFCLElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBUSxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ25CLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEdBQVEsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxXQUFXLEdBQVEsSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQVEs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SUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUIsQ0FBQztJQUNGLENBQUM7SUFFRCxVQUFVO1FBQ1QsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUs7UUFDSixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRCxJQUFJO1FBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7Q0FDRDtBQW5RRCxnQ0FtUUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG8tYWRtaW5cIiwgXCJNcXR0Q2xpZW50XCIpO1xuaW1wb3J0IGNvbnN0YW50cyA9IHJlcXVpcmUoXCIuLi8uLi91dGlsL2NvbnN0YW50c1wiKTtcbmltcG9ydCBNcXR0Q29uID0gcmVxdWlyZShcIm1xdHQtY29ubmVjdGlvblwiKTtcbmltcG9ydCBVdGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5pbXBvcnQgbmV0ID0gcmVxdWlyZShcIm5ldFwiKTtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcblxuZXhwb3J0IGNsYXNzIE1xdHRDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuXHRwcml2YXRlIGNsaWVudElkOiBzdHJpbmc7XG5cdHByaXZhdGUgaWQ6IHN0cmluZztcblx0cHJpdmF0ZSByZXF1ZXN0czogYW55O1xuXHRwcml2YXRlIGNvbm5lY3RlZFRpbWVzOiBudW1iZXI7XG5cdHByaXZhdGUgaG9zdDogc3RyaW5nO1xuXHRwcml2YXRlIHBvcnQ6IG51bWJlcjtcblx0cHJpdmF0ZSBzb2NrZXQ6IE1xdHRDb247XG5cdHByaXZhdGUgbGFzdFBpbmc6IG51bWJlcjtcblx0cHJpdmF0ZSBsYXN0UG9uZzogbnVtYmVyO1xuXHRwcml2YXRlIGNsb3NlZDogYm9vbGVhbjtcblx0cHJpdmF0ZSB0aW1lb3V0SWQ6IE5vZGVKUy5UaW1lcjtcblx0cHJpdmF0ZSBjb25uZWN0ZWQ6IGJvb2xlYW47XG5cdHByaXZhdGUgcmVjb25uZWN0SWQ6IE5vZGVKUy5UaW1lcjtcblx0cHJpdmF0ZSB0aW1lb3V0RmxhZzogYm9vbGVhbjtcblx0cHJpdmF0ZSBrZWVwYWxpdmVUaW1lcjogTm9kZUpTLlRpbWVyO1xuXHRwcml2YXRlIHJlY29ubmVjdERlbGF5ID0gMDtcblx0cHJpdmF0ZSByZWNvbm5lY3REZWxheU1heDogbnVtYmVyO1xuXHRwcml2YXRlIHRpbWVvdXQ6IG51bWJlcjtcblx0cHJpdmF0ZSBrZWVwYWxpdmU6IG51bWJlcjtcblx0Y29uc3RydWN0b3Iob3B0czogYW55KSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLmNsaWVudElkID0gXCJNUVRUX0FETUlOX1wiICsgRGF0ZS5ub3coKTtcblx0XHR0aGlzLmlkID0gb3B0cy5pZDtcblx0XHR0aGlzLnJlcXVlc3RzID0ge307XG5cdFx0dGhpcy5jb25uZWN0ZWRUaW1lcyA9IDE7XG5cdFx0dGhpcy5ob3N0ID0gPGFueT5udWxsO1xuXHRcdHRoaXMucG9ydCA9IDxhbnk+bnVsbDtcblx0XHR0aGlzLnNvY2tldCA9IDxhbnk+bnVsbDtcblx0XHR0aGlzLmxhc3RQaW5nID0gLTE7XG5cdFx0dGhpcy5sYXN0UG9uZyA9IC0xO1xuXHRcdHRoaXMuY2xvc2VkID0gZmFsc2U7XG5cdFx0dGhpcy50aW1lb3V0SWQgPSA8YW55Pm51bGw7XG5cdFx0dGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcblx0XHR0aGlzLnJlY29ubmVjdElkID0gPGFueT5udWxsO1xuXHRcdHRoaXMudGltZW91dEZsYWcgPSBmYWxzZTtcblx0XHR0aGlzLmtlZXBhbGl2ZVRpbWVyID0gPGFueT5udWxsO1xuXHRcdHRoaXMucmVjb25uZWN0RGVsYXkgPSAwO1xuXHRcdHRoaXMucmVjb25uZWN0RGVsYXlNYXggPVxuXHRcdFx0b3B0cy5yZWNvbm5lY3REZWxheU1heCB8fFxuXHRcdFx0Y29uc3RhbnRzLkRFRkFVTFRfUEFSQU0uUkVDT05ORUNUX0RFTEFZX01BWDtcblx0XHR0aGlzLnRpbWVvdXQgPSBvcHRzLnRpbWVvdXQgfHwgY29uc3RhbnRzLkRFRkFVTFRfUEFSQU0uVElNRU9VVDtcblx0XHR0aGlzLmtlZXBhbGl2ZSA9IG9wdHMua2VlcGFsaXZlIHx8IGNvbnN0YW50cy5ERUZBVUxUX1BBUkFNLktFRVBBTElWRTtcblx0fVxuXG5cdGNvbm5lY3QoaG9zdD86IHN0cmluZywgcG9ydD86IG51bWJlciwgY2I/OiBGdW5jdGlvbikge1xuXHRcdGNiID0gY2IgfHwgZnVuY3Rpb24oKSB7fTtcblx0XHRpZiAodGhpcy5jb25uZWN0ZWQpIHtcblx0XHRcdHJldHVybiBjYihuZXcgRXJyb3IoXCJNcXR0Q2xpZW50IGhhcyBhbHJlYWR5IGNvbm5lY3RlZC5cIikpO1xuXHRcdH1cblxuXHRcdGlmIChob3N0KSB7XG5cdFx0XHR0aGlzLmhvc3QgPSBob3N0O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRob3N0ID0gdGhpcy5ob3N0O1xuXHRcdH1cblxuXHRcdGlmIChwb3J0KSB7XG5cdFx0XHR0aGlzLnBvcnQgPSBwb3J0O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRwb3J0ID0gdGhpcy5wb3J0O1xuXHRcdH1cblxuXHRcdHRoaXMuY2xvc2VkID0gZmFsc2U7XG5cblx0XHRsZXQgc3RyZWFtID0gbmV0LmNyZWF0ZUNvbm5lY3Rpb24odGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuXHRcdHRoaXMuc29ja2V0ID0gbmV3IE1xdHRDb24oc3RyZWFtKTtcblxuXHRcdC8vIGxvZ2dlci5pbmZvKCd0cnkgdG8gY29ubmVjdCAlcyAlcycsIHRoaXMuaG9zdCwgdGhpcy5wb3J0KTtcblx0XHR0aGlzLnNvY2tldC5jb25uZWN0KHtcblx0XHRcdGNsaWVudElkOiB0aGlzLmNsaWVudElkXG5cdFx0fSk7XG5cblx0XHR0aGlzLmFkZFRpbWVvdXQoKTtcblxuXHRcdHRoaXMuc29ja2V0Lm9uKFwiY29ubmFja1wiLCAoKSA9PiB7XG5cdFx0XHRpZiAodGhpcy5jb25uZWN0ZWQpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG5cblx0XHRcdHRoaXMuc2V0dXBLZWVwQWxpdmUoKTtcblxuXHRcdFx0aWYgKHRoaXMuY29ubmVjdGVkVGltZXMrKyA9PSAxKSB7XG5cdFx0XHRcdHRoaXMuZW1pdChcImNvbm5lY3RcIik7XG5cdFx0XHRcdGNiISgpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5lbWl0KFwicmVjb25uZWN0XCIpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0dGhpcy5zb2NrZXQub24oXCJwdWJsaXNoXCIsIHBrZyA9PiB7XG5cdFx0XHRsZXQgdG9waWMgPSBwa2cudG9waWM7XG5cdFx0XHRsZXQgbXNnID0gcGtnLnBheWxvYWQudG9TdHJpbmcoKTtcblx0XHRcdG1zZyA9IEpTT04ucGFyc2UobXNnKTtcblxuXHRcdFx0Ly8gbG9nZ2VyLmRlYnVnKCdbTXF0dENsaWVudF0gcHVibGlzaCAlcyAlaicsIHRvcGljLCBtc2cpO1xuXHRcdFx0dGhpcy5lbWl0KHRvcGljLCBtc2cpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5zb2NrZXQub24oXCJjbG9zZVwiLCAoKSA9PiB7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFwibXF0dCBzb2NrZXQgaXMgY2xvc2UsIHJlbW90ZSBzZXJ2ZXIgaG9zdDogJXMsIHBvcnQ6ICVzXCIsXG5cdFx0XHRcdGhvc3QsXG5cdFx0XHRcdHBvcnRcblx0XHRcdCk7XG5cdFx0XHR0aGlzLm9uU29ja2V0Q2xvc2UoKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuc29ja2V0Lm9uKFwiZXJyb3JcIiwgZXJyID0+IHtcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XCJtcXR0IHNvY2tldCBpcyBlcnJvciwgcmVtb3RlIHNlcnZlciBob3N0OiAlcywgcG9ydDogJXNcIixcblx0XHRcdFx0aG9zdCxcblx0XHRcdFx0cG9ydFxuXHRcdFx0KTtcblx0XHRcdC8vIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ1tNcXR0Q2xpZW50XSBzb2NrZXQgaXMgZXJyb3IsIHJlbW90ZSBzZXJ2ZXIgJyArIGhvc3QgKyAnOicgKyBwb3J0KSk7XG5cdFx0XHR0aGlzLm9uU29ja2V0Q2xvc2UoKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuc29ja2V0Lm9uKFwicGluZ3Jlc3BcIiwgKCkgPT4ge1xuXHRcdFx0dGhpcy5sYXN0UG9uZyA9IERhdGUubm93KCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNvY2tldC5vbihcImRpc2Nvbm5lY3RcIiwgKCkgPT4ge1xuXHRcdFx0bG9nZ2VyLmVycm9yKFxuXHRcdFx0XHRcIm1xdHQgc29ja2V0IGlzIGRpc2Nvbm5lY3QsIHJlbW90ZSBzZXJ2ZXIgaG9zdDogJXMsIHBvcnQ6ICVzXCIsXG5cdFx0XHRcdGhvc3QsXG5cdFx0XHRcdHBvcnRcblx0XHRcdCk7XG5cdFx0XHR0aGlzLmVtaXQoXCJkaXNjb25uZWN0XCIsIHRoaXMuaWQpO1xuXHRcdFx0dGhpcy5vblNvY2tldENsb3NlKCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNvY2tldC5vbihcInRpbWVvdXRcIiwgcmVjb25uZWN0RmxhZyA9PiB7XG5cdFx0XHRpZiAocmVjb25uZWN0RmxhZykge1xuXHRcdFx0XHR0aGlzLnJlY29ubmVjdCgpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5leGl0KCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRzZW5kKHRvcGljOiBzdHJpbmcsIG1zZzogYW55KSB7XG5cdFx0Ly8gY29uc29sZS5sb2coJ01xdHRDbGllbnQgc2VuZCAlcyAlaiB+fn4nLCB0b3BpYywgbXNnKTtcblx0XHR0aGlzLnNvY2tldC5wdWJsaXNoKHtcblx0XHRcdHRvcGljOiB0b3BpYyxcblx0XHRcdHBheWxvYWQ6IEpTT04uc3RyaW5naWZ5KG1zZylcblx0XHR9KTtcblx0fVxuXG5cdG9uU29ja2V0Q2xvc2UoKSB7XG5cdFx0Ly8gY29uc29sZS5sb2coJ29uU29ja2V0Q2xvc2UgJyArIHRoaXMuY2xvc2VkKTtcblx0XHRpZiAodGhpcy5jbG9zZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjbGVhckludGVydmFsKHRoaXMua2VlcGFsaXZlVGltZXIpO1xuXHRcdGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRJZCk7XG5cdFx0dGhpcy5rZWVwYWxpdmVUaW1lciA9IDxhbnk+bnVsbDtcblx0XHR0aGlzLmxhc3RQaW5nID0gLTE7XG5cdFx0dGhpcy5sYXN0UG9uZyA9IC0xO1xuXHRcdHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG5cdFx0dGhpcy5jbG9zZWQgPSB0cnVlO1xuXHRcdGRlbGV0ZSB0aGlzLnNvY2tldDtcblx0XHR0aGlzLnNvY2tldCA9IDxhbnk+bnVsbDtcblxuXHRcdGlmICh0aGlzLmNvbm5lY3RlZFRpbWVzID4gMSkge1xuXHRcdFx0dGhpcy5yZWNvbm5lY3QoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5leGl0KCk7XG5cdFx0fVxuXHR9XG5cblx0YWRkVGltZW91dChyZWNvbm5lY3RGbGFnPzogYW55KSB7XG5cdFx0aWYgKHRoaXMudGltZW91dEZsYWcpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHR0aGlzLnRpbWVvdXRGbGFnID0gdHJ1ZTtcblxuXHRcdHRoaXMudGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHR0aGlzLnRpbWVvdXRGbGFnID0gZmFsc2U7XG5cdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFwibXF0dCBjbGllbnQgY29ubmVjdCAlczolZCB0aW1lb3V0ICVkIHNcIixcblx0XHRcdFx0dGhpcy5ob3N0LFxuXHRcdFx0XHR0aGlzLnBvcnQsXG5cdFx0XHRcdHRoaXMudGltZW91dCAvIDEwMDBcblx0XHRcdCk7XG5cdFx0XHR0aGlzLnNvY2tldC5lbWl0KFwidGltZW91dFwiLCByZWNvbm5lY3RGbGFnKTtcblx0XHR9LCB0aGlzLnRpbWVvdXQpO1xuXHR9XG5cblx0cmVjb25uZWN0KCkge1xuXHRcdGxldCBkZWxheSA9XG5cdFx0XHR0aGlzLnJlY29ubmVjdERlbGF5ICogMiB8fCBjb25zdGFudHMuREVGQVVMVF9QQVJBTS5SRUNPTk5FQ1RfREVMQVk7XG5cdFx0aWYgKGRlbGF5ID4gdGhpcy5yZWNvbm5lY3REZWxheU1heCkge1xuXHRcdFx0ZGVsYXkgPSB0aGlzLnJlY29ubmVjdERlbGF5TWF4O1xuXHRcdH1cblxuXHRcdHRoaXMucmVjb25uZWN0RGVsYXkgPSBkZWxheTtcblxuXHRcdC8vIGxvZ2dlci5kZWJ1ZygnW01xdHRDbGllbnRdIHJlY29ubmVjdCAlZCAuLi4nLCBkZWxheSk7XG5cdFx0dGhpcy5yZWNvbm5lY3RJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0bG9nZ2VyLmluZm8oXCJyZWNvbm5lY3QgZGVsYXkgJWQgc1wiLCBkZWxheSAvIDEwMDApO1xuXHRcdFx0dGhpcy5hZGRUaW1lb3V0KHRydWUpO1xuXHRcdFx0dGhpcy5jb25uZWN0KCk7XG5cdFx0fSwgZGVsYXkpO1xuXHR9XG5cblx0c2V0dXBLZWVwQWxpdmUoKSB7XG5cdFx0Y2xlYXJUaW1lb3V0KHRoaXMucmVjb25uZWN0SWQpO1xuXHRcdGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRJZCk7XG5cblx0XHR0aGlzLmtlZXBhbGl2ZVRpbWVyID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuXHRcdFx0dGhpcy5jaGVja0tlZXBBbGl2ZSgpO1xuXHRcdH0sIHRoaXMua2VlcGFsaXZlKTtcblx0fVxuXG5cdGNoZWNrS2VlcEFsaXZlKCkge1xuXHRcdGlmICh0aGlzLmNsb3NlZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCBub3cgPSBEYXRlLm5vdygpO1xuXHRcdGxldCBLRUVQX0FMSVZFX1RJTUVPVVQgPSB0aGlzLmtlZXBhbGl2ZSAqIDI7XG5cdFx0aWYgKHRoaXMubGFzdFBpbmcgPiAwKSB7XG5cdFx0XHRpZiAodGhpcy5sYXN0UG9uZyA8IHRoaXMubGFzdFBpbmcpIHtcblx0XHRcdFx0aWYgKG5vdyAtIHRoaXMubGFzdFBpbmcgPiBLRUVQX0FMSVZFX1RJTUVPVVQpIHtcblx0XHRcdFx0XHRsb2dnZXIuZXJyb3IoXG5cdFx0XHRcdFx0XHRcIm1xdHQgcnBjIGNsaWVudCBjaGVja0tlZXBBbGl2ZSBlcnJvciB0aW1lb3V0IGZvciAlZFwiLFxuXHRcdFx0XHRcdFx0S0VFUF9BTElWRV9USU1FT1VUXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR0aGlzLmNsb3NlKCk7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMuc29ja2V0LnBpbmdyZXEoKTtcblx0XHRcdFx0dGhpcy5sYXN0UGluZyA9IERhdGUubm93KCk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuc29ja2V0LnBpbmdyZXEoKTtcblx0XHRcdHRoaXMubGFzdFBpbmcgPSBEYXRlLm5vdygpO1xuXHRcdH1cblx0fVxuXG5cdGRpc2Nvbm5lY3QoKSB7XG5cdFx0dGhpcy5jbG9zZSgpO1xuXHR9XG5cblx0Y2xvc2UoKSB7XG5cdFx0dGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcblx0XHR0aGlzLmNsb3NlZCA9IHRydWU7XG5cdFx0dGhpcy5zb2NrZXQuZGlzY29ubmVjdCgpO1xuXHR9XG5cblx0ZXhpdCgpIHtcblx0XHRsb2dnZXIuaW5mbyhcImV4aXQgLi4uXCIpO1xuXHRcdHByb2Nlc3MuZXhpdCgwKTtcblx0fVxufVxuIl19